<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-04-22 Mon 18:39 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CMSC216 Project 4: Make me a Bake</title>
<meta name="author" content="Chris Kauffman" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<meta name="viewport" content="width=device-width, maximum-scale=1, minimum-scale=1" />
<style type="text/css">
@media screen {
:root {
--heading-bg-color:#e21833;
--heading-fg-color:#ffd200;
}
html {
font-family: serif;
text-align: justify;
}
pre.src, pre.example {
overflow-x: scroll;
}
/* Merge subtitle area with title area */
.subtitle {
text-align: center;
margin-top: -2em;
padding-top: 1em;
padding-bottom: 0.1em;
}
.title, .subtitle {
color: var(--heading-fg-color);
background-color: var(--heading-bg-color);
}
/* Section borders, left section header style */
div.outline-2, #table-of-contents {
background-color: rgb(250,250,250);
border: 0.75em solid var(--heading-bg-color);
border-top: 0em;
padding: 0em .5em .5em .5em; /* top right bottom left */
margin: 1em 0em 1em 0em; /* top right bottom left */
}
div.outline-2 > h2, #table-of-contents > h2 {
background-color: var(--heading-bg-color);
color: var(--heading-fg-color);
font-variant: small-caps;
padding: 0em 0em 0em .5em; /* top right bottom left */
margin: 0em -.5em 0em -.75em; /* top right bottom left */
text-align: left;
}
blockquote {
font-style: italic;
}
td, th {
padding-top: 2px;
padding-bottom: 2px;
}
body {
background-color: #EEE;
}
pre {
}
#content, #preamble, #postamble {
margin-left:300px;
max-width: 100%;
}
.tag {
background-color: inherit; font-family: inherit;
padding: inherit; font-size: 80%; font-weight: inherit;
text-transform: uppercase;
}

.figure p { text-align: inherit; }
figure-number { font-style: italic; }
#table-of-contents {
text-align: left;
position: fixed;
left: 0;
margin: 0 auto;
padding: 0;
width: 300px;
top: 0;
height: 100%;
border: 0;
display: block;
}
#text-table-of-contents {
overflow-y: scroll;
height: 100%;
}
#text-table-of-contents ul {
padding-left: 1em;
margin-left: 0.5em;
}
#table-of-contents > h2 {
padding: 0.1em;
margin: 0;
}
/* adjustments for small screen, toc at top only */
@media (max-width: 800px) { /* landscape for iphone */
html {
-webkit-text-size-adjust: none;  /* prevent scaling of text on mobile */
}
body {
background-color: #EEE;
width:100%;
margin:0 auto;
}
#content, #preamble, #postamble {
margin-left:0;
}
#table-of-contents {
position: static;
left: inherit;
width:inherit;
height: auto;
border-top: 0em;
padding: 0em .5em .5em .5em; /* top right bottom left */
margin: 1em 0em 1em 0em; /* top right bottom left */
border: 0.75em solid #006633;
}
div.outline-2, #table-of-contents {
background-color: rgb(250,250,250);
border: 0.75em solid var(--heading-bg-color);
border-top: 0em;
padding: 0em .5em .5em .5em; /* top right bottom left */
margin: 1em 0em 1em 0em; /* top right bottom left */
}
div.outline-2 > h2, #table-of-contents > h2 {
background-color: var(--heading-bg-color);
color: var(--heading-fg-color);
font-variant: small-caps;
padding: 0em 0em 0em .5em; /* top right bottom left */
margin: 0em -.5em 0em -.75em; /* top right bottom left */
text-align: left;
}
#text-table-of-contents {
overflow-y: visible;
height: inherit;
}
#text-table-of-contents ul {
padding-left: 1em;
margin-left: 0.5em;
}
}
.linenr { font-size: xx-small; }
}

@media print {
html {
font-family: serif;
font-size: 10pt;
text-align: justify;
.linenr { font-size: xx-small; }
}
}
</style>
<style>
/* Theme: Srcery
Description: Srcery dark color scheme for highlight.js
Author: Chen Bin <chen.bin@gmail.com>
Maintainer: @redguardtoo
Website: https://srcery-colors.github.io/
Date: 2021-04-13
https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/srcery.css

Tailored by: Chris Kauffman <profk@umd.edu>
Date: Sat Nov 25 06:16:20 PM EST 2023
*/
pre code.hljs {
display: block;
overflow-x: auto;
padding: 1em
}
code.hljs {
padding: 3px 5px
}
.hljs {
background: #1C1B19;
/* Black */
color: #FFFFFF/* Bright White */

}
/* Bright White */
.hljs-subst,
.hljs-quote,
.hljs-literal {
color: #FCE8C3
}
/* Bright Blue */
.hljs-type,
.hljs-symbol {
color: #68A8E4
}
/* Red */
.hljs-keyword,
.hljs-deletion {
color: #EF2F27
}
/* Yellow */
.hljs-name,
.hljs-function,
.hljs-attribute,
.hljs-selector-attr,
.hljs-selector-id,
.hljs-selector-class,
.hljs-selector-pseudo,
.hljs-section,
.hljs-title {
color: #FBB829
}
/* Cyan */
.hljs-code,
.hljs-variable,
.hljs-property,
.hljs-template-variable,
.hljs-class {
color: #0AAEB3
}
/* Bright Green */
.hljs-string,
.hljs-regexp,
.hljs-bullet,
.hljs-addition {
color: #98BC37
}
/* Bright Magenta */
.hljs-built_in,
.hljs-params {
color: #FF5C8F
}
/* Blue */
.hljs-template-tag,
.hljs-selector-tag {
color: #2C78BF
}
/* Bright Black */
.hljs-link,
.hljs-number,
.hljs-comment,
.hljs-meta {
color: #B1B195
/* color: #918175 */
}
.hljs-emphasis {
font-style: italic
}
.hljs-strong {
font-weight: bold
}
/* @see https://github.com/srcery-colors/srcery-emacs for reference */
</style>

<link rel="stylesheet" href="./srcery-ck.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', (event) => {
function interactive_lang() {      // define a custom "interactive" language
return {
name: 'interactive',           // language name
keywords: {
$pattern: /[^ \t\n]+/,       // lex based on non-whitespace
keyword: [">>","(shellac)","homeputer>","grace10:","HM>"], // allowed interactive prompts
},
contains: [
// hljs.HASH_COMMENT_MODE,   // use standard hash comments, any # is a comment
hljs.COMMENT(/#+ /, /$/),    // use custom comment of # w/ whitespace
]
};
};
hljs.registerLanguage('interactive', interactive_lang);     // register custom language

// Add highlighjs CSS classes to elemens marked with relevant org classes
lang_map = new Map();              // map of org to hljs languages
lang_map.set("src-c"    , "language-c");
lang_map.set("src-text" , "language-plaintext");
lang_map.set("src-sh"   , "language-interactive");
function add_class(el) {           // applied to each pre.src element
for (let [org_lang, hljs_lang] of lang_map) {
if(el.classList.contains(org_lang)){
el.classList.add(hljs_lang);
}
}
}
// visit all pre.src elements and apply function to add language class
document.querySelectorAll('pre.src').forEach(add_class);
hljs.configure({cssSelector: 'pre'}); // select pre blocks only to highligh
hljs.highlightAll();                  // perform highlighting on all pre blocks
});
</script>
</head>
<body>
<div id="preamble" class="status">
<i>Last Updated: 2024-04-22 Mon 18:39</i>
</div>
<div id="content" class="content">
<h1 class="title">CMSC216 Project 4: Make me a Bake</h1>
<ul class="org-ul">
<li><b>Due: 11:59pm Wed 24-Apr-2024</b></li>
<li><i>Approximately 3.0-4.0% of total grade</i></li>
<li>Submit to <a href="https://www.gradescope.com/"><b>Gradescope</b></a> <i>(Now Available)</i></li>
<li>Projects are <b>individual work</b>: no collaboration with other students
is allowed. Seek help from course staff if you get stuck for too long.</li>
</ul>

<div id="outline-container-orgf7e16d9" class="outline-4">
<h4 id="orgf7e16d9">CODE/TEST DISTRIBUTION: <a href="p4-code.zip">p4-code.zip</a></h4>
</div>

<div id="outline-container-org2b66643" class="outline-4">
<h4 id="org2b66643">VIDEO OVERVIEW: <a href="https://youtu.be/a6eUq7uulD0">https://youtu.be/a6eUq7uulD0</a></h4>
</div>
<div id="outline-container-orgf178ec5" class="outline-4">
<h4 id="orgf178ec5">CHANGELOG:</h4>
<div class="outline-text-4" id="text-orgf178ec5">
<dl class="org-dl">
<dt>Mon Apr 22 06:35:44 PM EDT 2024</dt><dd><p>
<a href="#orge10853c">An Optional MAKEUP
CREDIT problem (Problem 5)</a> has been added to the project
specification. The problem centers around detecting cycles in the
graph of target/dependencies. Test cases are available and can be
downloaded from the current code pack OR by updating the project
files via:
</p>
<div class="org-src-container">
<pre class="src src-sh">  curl https://www.cs.umd.edu/~profk/216/p4-update.sh | /bin/bash 
</pre>
</div>

<p>
NOTE: some students reported that the update script did not work for
them. The current update script should be functional for all now. If
you have problems updating, follow up on the Piazza post announcing
this update.
</p></dd>

<dt>Fri Apr 19 01:40:29 PM EDT 2024</dt><dd><p>
A video overview for P4 has been
posted here:  <a href="https://youtu.be/a6eUq7uulD0">https://youtu.be/a6eUq7uulD0</a>.
</p>

<p>
The Gradescope submission link for P4 is now live.
</p></dd>

<dt>Fri Apr 19 11:33:18 AM EDT 2024</dt><dd><p>
Several posts including <a href="https://piazza.com/class/lrqszzrlvo46gm/post/683">@683</a>
identified that the current tests corrected spelling typo
<code>rule_capacity</code> rather than <code>rule_capcaity</code>.  This stems from the
provided function <code>bake_show_bake()</code> in <code>bake_util.c</code>.  You may
either fix the typo manually or re-run the project update script to
correct the typo:
</p>
<div class="org-src-container">
<pre class="src src-sh">  curl https://www.cs.umd.edu/~profk/216/p4-update.sh | /bin/bash 
</pre>
</div></dd>

<dt>Thu Apr 18 05:38:50 PM EDT 2024</dt><dd><p>
The second phase is complete with
descriptions added and test cases for Problems 3 &amp; 4 now in the
codepack. For those who whish to update an existing project, run the
following command in a Unix terminal:
</p>
<div class="org-src-container">
<pre class="src src-sh">  curl https://www.cs.umd.edu/~profk/216/p4-update.sh | /bin/bash 
</pre>
</div>
<p>
This will create backup copies of existing test files then download
the up to date files.
</p>

<p>
Several bugs in the Problem 1&amp;2 tests are fixed in this release such
as inconsistent I/O flags and errant single quotes that appear on
Linux systems but not on Grace.  There likely remain further bugs
but these will be dealt with in time.
</p></dd>

<dt>Thu Apr 18 01:30:34 PM EDT 2024</dt><dd>A <a href="#orge27c191">section
has been added to clarify some aspects of <code>bake_add_empty_rule()</code></a>
such as encouraging the use of the <code>realloc()</code> and <code>memset()</code>
functions to quickly implement some required behavior.</dd>

<dt>Tue Apr 16 11:43:24 AM EDT 2024</dt><dd><p>
<a href="https://piazza.com/class/lrqszzrlvo46gm/post/627">Post @627</a> expressed some
confusion and the potential that the <code>bake_create_from_file()</code>
function had errors. This is confusion centers around the the
responsibilities of the <code>bake_add_empty_rule()</code> function.  This
function MUST initialize the data of <code>rule_t</code> to <code>0 / NULL</code> before
returning a pointer to it. If it does not, test failures will
result.
</p>

<p>
To clarify and hint at an easy way to accomplish this initialization,
the documentation for the <code>bake_add_empty_rule()</code> has been expanded to
the following:
</p>

<div class="org-src-container">
<pre class="src src-c">  rule_t *bake_add_empty_rule(bake_t *bake);
  // PROBLEM 1: Modifies `bake` to add a new, empty rule to it and
  // returns a pointer to that rule. If bake-&gt;rules[] is full
  // (rule_capacity and rule_count are equal) doubles the size of
  // rules[] via realloc() in order create room at its end for the new
  // empty rule. Returns a pointer to the new empty rule.
  //
  // CLARIFICATION: This function intitalizes all the date in the
  // returned rule to NULL or 0 including the nested arrays. HINT:
  // make use of the memset() to quickly initialize the entire rule_t
  // struct to 0's. This is possible due to the nested arrays being
  // within the rule_t rather than pointers to other blocks of memory
  // which means a single memset() call will suffice.
  // 
  // CAUTION: Calling this function MAY invalidate any pointers to
  // existing rules as the array that houses the rules may move.
  // This sequence is dangerous:
  //   rule_t *rule  = bake_target_rule(bake, "sometarget");
  //   rule_t *empty = bake_add_empty_rule(bake);
  //   rule may now point to de-allocated memory
</pre>
</div></dd>
</dl>


<dl class="org-dl">
<dt>Tue Apr 16 11:03:20 AM EDT 2024</dt><dd>The missing <code>data/</code> directory
has been added into the project codepack.  You can also download it
independently here: <a href="data.zip">data.zip</a>. Details are in <a href="https://piazza.com/class/lrqszzrlvo46gm/post/620">Post @620</a>.</dd>
</dl>
</div>
</div>

<div id="outline-container-orga05c2e1" class="outline-4">
<h4 id="orga05c2e1"></h4>
<div class="outline-text-4" id="text-orga05c2e1">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org1ab3295">1. Overview</a></li>
<li><a href="#orge7d3ea2">2. Download Code and Setup</a></li>
<li><a href="#org18f1fa9">3. Overview of Bake</a>
<ul>
<li><a href="#org6f0fe6d">3.1. Bakefiles</a></li>
<li><a href="#orgfec9ba3">3.2. Data Structures</a></li>
<li><a href="#org54b232c">3.3. Outline of <code>bake_funcs.c</code></a></li>
<li><a href="#orgcc23975">3.4. Provided Utility Functions</a></li>
<li><a href="#org715af38">3.5. Sample Usage</a></li>
</ul>
</li>
<li><a href="#org3f2c0ef">4. <b>Problem 1</b>: Service Functions for Bake</a>
<ul>
<li><a href="#org1f5e265">4.1. Slurping Files</a></li>
<li><a href="#org84508a0">4.2. Looking up and Adding Rules</a></li>
<li><a href="#org741ef1e">4.3. Adding Implicit Rules</a></li>
<li><a href="#org564bc01">4.4. Printing Commands</a></li>
</ul>
</li>
<li><a href="#org4a037e2">5. <b>Problem 2</b>: Executing Commands</a>
<ul>
<li><a href="#org2c96b36">5.1. Fork / Exec / Wait</a></li>
<li><a href="#orga560ae9">5.2. Setting Up I/O Redirection</a></li>
<li><a href="#org3677ae5">5.3. Failure Detection</a></li>
</ul>
</li>
<li><a href="#org0a5fe93">6. <b>Problem 3</b>: Walking the Bake DAG</a>
<ul>
<li><a href="#orgf658743">6.1. Recursing on Bake Structs</a></li>
<li><a href="#orgaf1043a">6.2. Setting Update Flags</a></li>
<li><a href="#org045c4fa">6.3. Dealing with Files and Modification Times</a></li>
<li><a href="#org438f2b7">6.4. Performing Updates</a></li>
</ul>
</li>
<li><a href="#orgb0ecb97">7. <b>Problem 4</b>: Postprocessing and Main</a>
<ul>
<li><a href="#org5c2b329">7.1. Post Processing</a></li>
<li><a href="#org38826b5">7.2. Main Function</a></li>
</ul>
</li>
<li><a href="#org717193f">8. Grading Criteria</a></li>
<li><a href="#orgc56213a">9. Problem 5: Optional Makeup Credit</a>
<ul>
<li><a href="#org1b01790">9.1. <code>bake_check_cycles()</code></a></li>
<li><a href="#org4e6c83e">9.2. Bake <code>main()</code> for Cycle Checking</a></li>
<li><a href="#org4955e8b">9.3. Problem 5 Grading Criteria</a></li>
</ul>
</li>
<li><a href="#org7449691">10. Assignment Submission</a>
<ul>
<li><a href="#orgdbd9d3a">10.1. Submit to Gradescope</a></li>
<li><a href="#orge0a6195">10.2. Late Policies</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org1ab3295" class="outline-2">
<h2 id="org1ab3295"><span class="section-number-2">1</span> Overview</h2>
<div class="outline-text-2" id="text-1">
<p>
Build systems pervade software development. They automate repetitive
tasks and raise the quality of software by making it easier to create
and test software efficiently. Make and its Makefiles is a venerable
example of a build system that has stood the test of time. While it
has some quirks, it is well worth knowing how to use Makefiles as well
as know some details of the internal implementation of such systems.
</p>

<p>
This project will build a simplified version of Make called <b>Bake</b>
which uses <b>Bakefiles</b> that have a simplified syntax compared to
Makefiles but implement the core principles of a build system. These
principles include the following which are all related to systems
programming:
</p>
<ul class="org-ul">
<li>Creating child processes to execute external commands</li>
<li>Examining files on the file system to determine attributes such as
presence / absence and modification time</li>
<li>Recursively traversing a data structure representing dependencies
and executing commands to update targets or detecting that no such
updates are needed.</li>
</ul>
</div>

<div id="outline-container-org17ea5f0" class="outline-4">
<h4 id="org17ea5f0">Special Note on Staged Release</h4>
<div class="outline-text-4" id="text-org17ea5f0">
<p>
This project will be released in 2 phases.
</p>
<ul class="org-ul">
<li>The Initial release includes overall information with details and
test cases for Problems 1&amp;2</li>
<li>About 5 days after the initial release, details and test cases for
Problems 3&amp;4 will be released.</li>
<li>A few days after that, several MAKEUP credit problems will become
available.</li>
</ul>
<p>
The project is of medium size so you are encouraged to begin working
on problems as they become available.
</p>
</div>
</div>
</div>

<div id="outline-container-orge7d3ea2" class="outline-2">
<h2 id="orge7d3ea2"><span class="section-number-2">2</span> <a id="orgc62f49b"></a> Download Code and Setup</h2>
<div class="outline-text-2" id="text-2">
<p>
Download the code pack linked at the top of the page. Unzip this which
will create a project folder. Create new files in this
folder. Ultimately you will re-zip this folder to submit it.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">File</th>
<th scope="col" class="org-left">State</th>
<th scope="col" class="org-left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>bake.h</code></td>
<td class="org-left">Provided</td>
<td class="org-left">Header file for shellac</td>
</tr>

<tr>
<td class="org-left"><code>bake_util.c</code></td>
<td class="org-left">Provided</td>
<td class="org-left">Utility functions provided</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>bake_funcs.c</code></td>
<td class="org-left">CREATE</td>
<td class="org-left">Functions that operate data in the Bake system</td>
</tr>

<tr>
<td class="org-left"><code>bake_main.c</code></td>
<td class="org-left">CREATE</td>
<td class="org-left">main() function for the Bake</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Build/Testing Files</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>Makefile</code></td>
<td class="org-left">Provided</td>
<td class="org-left">Build file to compile all programs</td>
</tr>

<tr>
<td class="org-left"><code>testy</code></td>
<td class="org-left">Testing</td>
<td class="org-left">Test running script</td>
</tr>

<tr>
<td class="org-left"><code>test_bake12.c</code></td>
<td class="org-left">Testing</td>
<td class="org-left">Unit tests for Problems 1 &amp; 2</td>
</tr>

<tr>
<td class="org-left"><code>test_prob1.org</code></td>
<td class="org-left">Testing</td>
<td class="org-left">Tests for Problem 1</td>
</tr>

<tr>
<td class="org-left"><code>test_prob2.org</code></td>
<td class="org-left">Testing</td>
<td class="org-left">Tests for Problem 2</td>
</tr>

<tr>
<td class="org-left"><code>test_bake34.c</code></td>
<td class="org-left">Testing</td>
<td class="org-left">Unit tests for Problems 3 &amp; 4 <i>Not yet Released</i></td>
</tr>

<tr>
<td class="org-left"><code>test_prob3.org</code></td>
<td class="org-left">Testing</td>
<td class="org-left">Tests for Problem 3 <i>Not yet Released</i></td>
</tr>

<tr>
<td class="org-left"><code>test_prob4.org</code></td>
<td class="org-left">Testing</td>
<td class="org-left">Tests for Problem 4 <i>Not yet Released</i></td>
</tr>

<tr>
<td class="org-left"><code>test-data/</code></td>
<td class="org-left">Testing</td>
<td class="org-left">Subdirectory with files / programs used during testing</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org18f1fa9" class="outline-2">
<h2 id="org18f1fa9"><span class="section-number-2">3</span> Overview of Bake</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org6f0fe6d" class="outline-3">
<h3 id="org6f0fe6d"><span class="section-number-3">3.1</span> Bakefiles</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Bake/Bakefiles share many similiarities with Make/Makefiles. Readers
are assumed to have some familiarity with Makefiles. If not, consult
<a href="lab10.html">previous course materials</a> the introduce them and/or review <a href="https://www.gnu.org/software/make/manual/make.html">external
manuals and documentation</a> that describe the essence of Makefiles.
</p>

<p>
Below is a sample Bakefile provided in the <code>data/Bakefile3</code>
</p>
<div class="org-src-container">
<pre class="src src-makefile"><span class="linenr"> 1: </span># SampleBakefile: a sample Bakefile. Run this with
<span class="linenr"> 2: </span># &gt;&gt; bake -f SampleBakefile
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span># lead target is 'demo' which will be used if
<span class="linenr"> 5: </span># no target is specified on the command line.
<span class="linenr"> 6: </span># Some of the commands have @ as their prefix which
<span class="linenr"> 7: </span># silences the command.
<span class="linenr"> 8: </span>demo : hello bye
<span class="linenr"> 9: </span>	@ echo Running programs
<span class="linenr">10: </span>	./hello
<span class="linenr">11: </span>	./bye
<span class="linenr">12: </span>	@ echo Done running programs
<span class="linenr">13: </span>
<span class="linenr">14: </span>all : hello bye
<span class="linenr">15: </span>
<span class="linenr">16: </span># this is program 1 / 2
<span class="linenr">17: </span>hello : hello.o
<span class="linenr">18: </span>	gcc -o hello hello.o
<span class="linenr">19: </span>
<span class="linenr">20: </span>hello.o : hello.c
<span class="linenr">21: </span>	gcc -c hello.c
<span class="linenr">22: </span>
<span class="linenr">23: </span># this is program 2 / 2
<span class="linenr">24: </span>bye : bye.o
<span class="linenr">25: </span>	gcc -o bye bye.o
<span class="linenr">26: </span>
<span class="linenr">27: </span>bye.o : bye.c
<span class="linenr">28: </span>	gcc -c bye.c
<span class="linenr">29: </span>
<span class="linenr">30: </span># this target removes built files
<span class="linenr">31: </span>clean :
<span class="linenr">32: </span>	rm -f hello.o bye.o hello bye
<span class="linenr">33: </span>
<span class="linenr">34: </span># END of SampleBakefile
</pre>
</div>

<p>
A few notes on the features / non-features of Bakefiles.
</p>
<ul class="org-ul">
<li>Comments always start a line with <code>#</code>; comments are not
allowed elsewhere (such as after other parts)</li>
<li>Blank lines are allowed and have no effect on builds</li>
<li>Any other line is presumed to start a Rules of the same type
Makefiles use <code>target : dependencies</code> and the a list of
space-indented commands</li>
<li>It is required that <code>target</code> and <code>dependency</code> are space separated by
the colon. <code>target : dep1 dep2</code> is fine, <code>target: dep1 dep2</code> is not
supported.</li>
<li>Commands that start with <code>@ cmd</code> will cause the command to be
Silenced during builds. The Space after <code>@</code> is required.</li>
<li>No variable substitution presently supported and no automatic
variables such as <code>$@</code> are supported</li>
</ul>

<p>
Generally Bakefiles are a subset of Makefiles so <code>make</code> should work
for Bakefiles (e.g. <code>make -f Bakefile</code> should build) The output of
<code>bake</code> will be a little different than <code>make</code> but accomplish the same
task. 
</p>
</div>
</div>

<div id="outline-container-orgfec9ba3" class="outline-3">
<h3 id="orgfec9ba3"><span class="section-number-3">3.2</span> Data Structures</h3>
<div class="outline-text-3" id="text-3-2">
<p>
There are 3 central data structures used in Bake which are found in
the header <code>bake.h</code>.
</p>
<dl class="org-dl">
<dt><code>cmd_t</code></dt><dd>Encodes information about a single command like <code>gcc -o myprog
  x.o y.o</code> from a Bakefile.</dd>
<dt><code>rule_t</code></dt><dd>Encodes an entire rule from a Bakefile including its
target, dependencies, and an array of <code>cmd_t</code> structs for each of
the commands to run.</dd>
<dt><code>bake_t</code></dt><dd>Encodes the entire contents of a Bakefile. It's main
feature is an array of <code>rule_t</code> structs and a <b>String Table</b>: a
single large string with other parts of the data structure pointing
into it for their own strings.</dd>
</dl>

<p>
It is worthwhile spend some time acquainting yourself with some of the
documentation on these structs provided in <code>bake.h</code>. Refer back to the
header often as you need to recall parts of the data.
</p>

<p>
<b>DESIGN NOTE</b>: The data structures are designed as a compromise
between minimizing the need to <code>malloc()</code> memory while still providing
reasonable flexibility to handle Bakefiles. One notable tradeoff that
will affect your code
</p>
<ul class="org-ul">
<li>The <code>rules[]</code> array in <code>bake_t</code> is <code>malloc()'d</code> so can grow via
re-allocation. It therefore tracks both <code>rule_capcity</code> (size of the
array) and <code>rule_count</code>, the number of elements in the array.</li>
<li>Other arrays are fixed length: <code>deps[]</code> and <code>cmds[]</code> in <code>rule_t</code> and
<code>tokens[]</code> in <code>cmd_t</code> have a fixed size. In a production setting,
one might reconsider this but using fixed sizes here simplifies much
of the parsing difficulty by pre-allocating space for these arrays.</li>
</ul>
</div>
</div>

<div id="outline-container-org54b232c" class="outline-3">
<h3 id="org54b232c"><span class="section-number-3">3.3</span> Outline of <code>bake_funcs.c</code></h3>
<div class="outline-text-3" id="text-3-3">
<p>
The primary implementation files required are <code>bake_funcs.c</code> and
<code>bake_main.c</code>.  As the name suggests, <code>bake_main.c</code> will contain the
<code>main()</code> function and is part of the final problem. 
</p>

<p>
<code>bake_funcs.c</code> has a number of "service" functions which manipulate
Bake data. Each of these is required and will be tested. The outline
and some brief documentation for them is below.
</p>
<div class="org-src-container">
<pre class="src src-c">// bake_funcs.c: required service functions for handling of Bakefiles

////////////////////////////////////////////////////////////////////////////////
// PROBLEM 1
////////////////////////////////////////////////////////////////////////////////

char *slurp_file_efficient(char *fname);
// PROBLEM 1: Uses combination of stat() and read() to efficiently
// read in the entire contents of a file into a malloc()'d block of
// memory, null terminates it (\0). Returns a pointer to the file data
// or NULL if the file could not be opened. If the file can't be
// opened, use perror() to print "Couldn't open file" and why.

rule_t *bake_target_rule(bake_t *bake, char *targname);
// PROBLEM 1: Searches bake for a rule with a target that equals
// `targname`. If found, returns a pointer to that rule. Otherwise
// returns NULL if no rule with target `targname` exists.
//
// DESIGN NOTE: The curent design makes use of linear search for
// target location, O(rule_count) for each lookup. Maintainting a hash
// table of target-&gt;rule key/vals would allow O(1) lookup for rules
// with given target names.

rule_t *bake_add_empty_rule(bake_t *bake);
// PROBLEM 1: Modifies `bake` to add a new, empty rule to it and
// returns a pointer to that rule. If bake-&gt;rules[] is full
// (rule_capacity and rule_count are equal) doubles the size of
// rules[] via realloc() in order create room at its end for the new
// empty rule. Returns a pointer to the new empty rule.
//
// CLARIFICATION: This function intitalizes all the date in the
// returned rule to NULL or 0 including the nested arrays. HINT: make
// use of the memset() to quickly initialize the entire rule_t struct
// to 0's. This is possible due to the nested arrays being within the
// rule_t rather than pointers to other blocks of memory which means a
// single memset() call will suffice.
// 
// CAUTION: Calling this function MAY invalidate any pointers to
// existing rules as the array that houses the rules may move.
// This sequence is dangerous:
//   rule_t *rule  = bake_target_rule(bake, "sometarget");
//   rule_t *empty = bake_add_empty_rule(bake);
//   rule may now point to de-allocated memory

int bake_add_implicit_rules(bake_t *bake);
// PROBLEM 1: Iterate over all rules appending implicit rules for any
// dependency that is not an explicit target. New rules added in this
// way are marked with the RULE_IMPLICIT_BIT.
//
// CAUTION: Since bake-&gt;rules[] may expand, care must be taken when
// referencing rules in this function to avoid inadvertently derefing
// a pointer to free()'d memory.

void bake_print_cmd(cmd_t *cmd);
// PROBLEM 1: If the SILENCE_BIT is set, does nothing and immediately
// returns. Otherwise, prints the given command token by token. If I/O
// redirects are indicated by the fields of the command, prints the
// after all tokens with "&lt; infile" for input followed by "&gt; outfile"
// if present. This function is used to print out commands in
// bake_execute_cmd().

////////////////////////////////////////////////////////////////////////////////
// PROBLEM 2
////////////////////////////////////////////////////////////////////////////////

int bake_execute_cmd(cmd_t *cmd);
// PROBLEM 2: Called during bake_do_update(). Prints the command using
// bake_print_cmd() unless its SILENCE bit is set. fork()'s a child
// process which exec's the command specified in cmd-&gt;tokens.  Sets up
// I/O redirection in child process if indicated by cmd flags and
// fields. Uses a wait() call to wait until the child process is
// done. If the child completes normally, its exit code is passed up,
// 0 or non-zero. If the child process fails to complete normally or
// prints an error message with line number of command
// CMD_NONSTAND_EXIT. Non-zero returns from this function will usually
// be handled in a build by cancelling the build whil 0 return will
// cause the build to prceed and execute subsequent commands.
//
// During Input and Output redirection, if the requrested files cannot
// be opened, the child process exits with code CMD_FAIL_INPREDI or
// CMD_FAIL_OUTREDI. Additionally, if the child fails to exec() a
// command, CMD_FAIL_EXEC is used as its return code. All of these are
// non-zero and trigger builds to fail. In the above failure cases,
// prints one of the below error messages appropriate to the error.
// 
// perror("ERROR: can't open file for output")
// perror("ERROR: can't open file for output")
// perror("ERROR: job failed to exec");
//
// CLARIFICATION: When open()'ing files for output redirection,
// certain options should be passed to ensure that the created file
// adheres to conventions
// - For the second argument to open(), pass options
//     O_WRONLY|O_CREAT|O_TRUNC
//   which will open the file for writing, create it if not present,
//   and truncate the file if it already exists
// - For the third argument to open(), pass the arguments
//     S_IRUSR|S_IWUSR
//   which will set the "rw" permissions on the created file for the
//   owner (user) of the file

////////////////////////////////////////////////////////////////////////////////
// PROBLEM 3
////////////////////////////////////////////////////////////////////////////////

int bake_set_updates(bake_t *bake, char *targname);
// PROBLEM 3: Starting at `targname`, recurses down the
// target/dependency DAG setting the UPDATE bit in rule_flags to
// indicate whether a target requires updates. Makes use of the
// CLEAR_BIT(), CHECK_BIT(), and SET_BIT() macros when dealing with
// bit-manipulations. For a given rule, first visits all its
// dependencies to check if they require updates via recursion. Then
// determines if `targname` requires an update. The conditions that
// require an update are described in detail in the program
// specification and shoudl be consulted while implementing this
// function. Returns 1 if target needs to be updated so associated
// rule commands should be run later. Returns 0 if the named target
// does not need to be updated. Prints an error if targname is not
// found and returns -1. If any dependency returns -1, an error
// ocurred lower down the DAG. In case, nothing is printed nothing and
// -1 is returned up the nested recursion.

int bake_do_updates(bake_t *bake, char *targname);
// PROBLEM 3: Starting at `targname`, run commands if the UPDATE bit
// is set. Before running commands associated with `targname`,
// recursively visit dependencies and if their UPDATE bit is set, run
// their commands first. Returns number of rules that were updated or
// -1 to indicate an error ocurred while running commands.

////////////////////////////////////////////////////////////////////////////////
// PROBLEM 4
////////////////////////////////////////////////////////////////////////////////

int bake_cmd_postprocess(bake_t *bake, cmd_t *cmd);
// PROBLEM 4: Examines cmd-&gt;tokens to set cmd-&gt;flags and a few other
// fields. Used to post-process the raw tokens of a command. Likely
// uses the utility function array_shift() to ease the re-arrangment
// of arrays.
// 
// 1. If tokens[0] = "@", eliminates this token by shifting all tokens
// over and sets the SILENCED bit
// 
// 2. If tokens[i] = "&lt;", input redirection is desired; if tokens[i+1]
// is not NULL, returns -1. Otherwise sets the INPREDI bit and
// input_redirect field to tokens[i+1]. Then shifts all tokens over to
// eliminate tokens[i] and tokens[i+1].
// 
// 3. If tokens[i] = "&gt;", output redirection is desired and performs
// similar operations to #2 with the OUTREDI flag and output_redirect
// fields.
//
// Correctly handles any order of "&lt; input" / "&gt; output" and other
// tokens (ex: output redirection may appear first followed by normal
// tokens followed by input redirection)
// 
// If multiple "&lt;" or "&gt;" tokens appear, the behavior of this function
// is unspecified: it may return an error, segfault, or behave randomly.
// 
// Returns 0 on succesful completion.
//
// DESIGN NOTE: This function must be called prior to any commands
// being run. The ideal location is during parsing to modify commands
// as a bake_t structure is built. However, this functionality is
// separated out to enable future functionality such as variable
// substitution to be added to commands and tested separately from
// parsing. Any additional context needed for such things will be part
// of the 'bake' parameter (e.g. may contain a map of variable
// names/values for substitutions).

void bake_post_process(bake_t *bake);
// PROBLEM 4: Applies postprocessing operations to the bake after
// loading it from a file. Currently only iterates over all rules and
// applies bake_cmd_postprocess() to each of their commands.
//
// DESIGN NOTE: This function is where additional operations could be
// used to further modify the bakefile such as performing variable
// substitutions on rules / targets, including other bakefiles. etc.

////////////////////////////////////////////////////////////////////////////////
// PROBLEM 5 MAKEUP CREDIT (OPTIONAL)
////////////////////////////////////////////////////////////////////////////////

int bake_check_cycles(bake_t *bake, char *targname, int do_print);
// PROBLEM 5 MAKEUP: Analyzes `bake` starting at targname to
// deteremine if any cycles are present which would create problems
// completing a build: if targA depends on targB depends an targA, a
// cyclcil dependency exists and could not be fulfilled.  Returns 1 if
// a cycle is present, 0 if no cycle is present, and -1 if an error
// occurs such as not finding a needed target.
//
// If do_print is non-zero, prints out a message like:
// 
//   ERROR Cyclic Dependency detected:
//   fileA.txt -&gt; fileB.txt -&gt; fileC.txt -&gt; fileA.txt
// 
// where the first line is always identical and the second line shows
// the path from the initial target through a cycle. Implementations
// assume that these messages will fit in a 2048-byte array and have
// undefined behavior if the message is larger.
//
// NOTES: This function needs to initiate a recursive descent into
// `bake` via a helper function which does the brunt of the work.
// This helper function may be defined in whatever way with whatever
// prototype is convenient. Global variables may be used to help
// generate cycle message BUT implementations with pride will find
// ways to avoid the use of global variables.

</pre>
</div>
</div>
</div>

<div id="outline-container-orgcc23975" class="outline-3">
<h3 id="orgcc23975"><span class="section-number-3">3.4</span> Provided Utility Functions</h3>
<div class="outline-text-3" id="text-3-4">
<p>
The emphasis of the project is on utilizing some system calls to
achieve an interesting effect. To that end, some code is provided to
focus attention on these aspects of the project. Most of these
functions will be used by code in <code>bake_funcs.c</code> or the <code>main()</code>
function so consult these enough to know how to use them.
</p>

<p>
Notable functions are:
</p>
<dl class="org-dl">
<dt><code>Dprintf()</code></dt><dd>Print a debugging message which is only shown if an
environment variable is set. Extremely useful during debugging and
alleviates the need to remove debugging messages after the fact.</dd>

<dt><code>array_shift()</code></dt><dd>moves around elements in an array to "delete"
one. Useful when post-processing the tokens in a <code>cmd_t</code>.</dd>

<dt><code>bake_create_from_file()</code></dt><dd>reads the contents of a file and create
a <code>bake_t</code> from it. This is tricky code worth studying but students
are not required to modify it in any way, just use it in <code>main()</code> to
load a specified file then post-process the data structure before
operating on it. The function makes use <code>slurp_file_efficient()</code>
which students will need to write.</dd>
</dl>

<p>
Below is an outline of the provided function. The full source can be
viewed in the indicated source file.
</p>
<div class="org-src-container">
<pre class="src src-c">// bake_util.c: provided functions for the bake program

////////////////////////////////////////////////////////////////////////////////
// string processing
////////////////////////////////////////////////////////////////////////////////

void split_into_lines(char *text, char ***lines, int *nlines);
// Modifies `text` so that each line ends with a \0 (rather than
// \n). Sets lines to point to a malloc()'d array of the start of each
// line. Sets nlines to be the number of lines.
//
// EXAMPLE:
// char text[32] = "every good\nboy does fine\nFACEG\n\0";
// char **lines; int nlines;
// split_into_lines(text, &amp;lines, &amp;nlines);
// - text[] is now "every good\0boy does fine\0FACEG\0\0"
// - nlines is now 4
// - lines is now {"every good","boy does fine","FACEG",""}
// - lines[i] points into text[]

void split_into_tokens(char *line, char ***tokens, int *ntokens);
// Modifies line so that whitespace-separate characters are replaced
// with \0's to denote 'tokens'. Sets parameter `tokens` to be a
// malloc()'d array with pointers to each of the tokens. Sets ntokens
// to be the nubmer of tokens in the line.
//
// EXAMPLE:
// char line[32] = "hello  :  friendly world\0";
// char **tokens; int notkens;
// split_into_tokens(line, &amp;tokens, &amp;ntokens);
// - line[] is now "hello\0\0:\0\0friendly\0world\0"
// - ntokens is now 4
// - tokens is now {"hello",":","friendly","world"}
// - tokens[i] points into line[]

////////////////////////////////////////////////////////////////////////////////
// general utilities
////////////////////////////////////////////////////////////////////////////////

void array_shift(char *strs[], int delpos, int maxlen);
// shift the array of strings left by 1 starting at delpos; eliminates
// delpos from the array.

long diff_timespec(struct timespec a, struct timespec b);
// returns difference in times between a-b; positive return means a is
// newer than b; negative indicates b is newer than a

void Dprintf(const char* format, ...);
// Prints out a message if the environment variable DEBUG is set;
// Try running as `DEBUG=1 ./some_program`

void ind_printf(int ind, const char* format, ...);
// Like printf but indents 'ind' spaces; used for printing recursive
// data structures

////////////////////////////////////////////////////////////////////////////////
// bake-specific provided functions
////////////////////////////////////////////////////////////////////////////////

bake_t *bake_create_from_file(char *fname);
// parse file and create a bakefile from it

void bake_free(bake_t *bake);
// De-allocates memory associated with a bake_t

void bake_show_cmd(cmd_t *cmd, int ind);
// print a formatted version of cmd_t for testing / debugging

void bake_show_rule(rule_t *rule, int ind);
// print a formatted version of a rule_t for testing / debugging

void bake_show_bake(bake_t *bake, int ind);
// print a formatted version of a bake_t for testing / debugging

</pre>
</div>
</div>
</div>

<div id="outline-container-org715af38" class="outline-3">
<h3 id="org715af38"><span class="section-number-3">3.5</span> Sample Usage</h3>
<div class="outline-text-3" id="text-3-5">
<p>
Below is an example use of the complete <code>bake</code> program to perform
make-like activities in the provided <code>data/</code> directory.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="linenr">  1: </span># Demonstration of bake 
<span class="linenr">  2: </span>&gt;&gt; cd p4-code
<span class="linenr">  3: </span>
<span class="linenr">  4: </span>&gt;&gt; make bake
<span class="linenr">  5: </span>gcc -Wall -Wno-comment -Werror -g -Wno-format-security -c bake_funcs.c
<span class="linenr">  6: </span>gcc -Wall -Wno-comment -Werror -g -Wno-format-security -c bake_main.c
<span class="linenr">  7: </span>gcc -Wall -Wno-comment -Werror -g -Wno-format-security -c bake_util.c
<span class="linenr">  8: </span>gcc -Wall -Wno-comment -Werror -g -Wno-format-security -o bake bake_funcs.o bake_main.o bake_util.o
<span class="linenr">  9: </span>
<span class="linenr"> 10: </span>&gt;&gt; cd data
<span class="linenr"> 11: </span>
<span class="linenr"> 12: </span>&gt;&gt; cat Bakefile1                          # show a sample Bakefile
<span class="linenr"> 13: </span># this is a comment
<span class="linenr"> 14: </span>
<span class="linenr"> 15: </span>hello : hello.c
<span class="linenr"> 16: </span>      gcc -o hello hello.c
<span class="linenr"> 17: </span>
<span class="linenr"> 18: </span># this is the end of the Bakefile
<span class="linenr"> 19: </span>
<span class="linenr"> 20: </span>&gt;&gt; ../bake -f Bakefile1                   # use bake to build the targets
<span class="linenr"> 21: </span>bake: updating 'hello' via 1 command(s)
<span class="linenr"> 22: </span>gcc -o hello hello.c 
<span class="linenr"> 23: </span>bake complete, 1 update(s) performed
<span class="linenr"> 24: </span>
<span class="linenr"> 25: </span>&gt;&gt; ./hello                                # run the built program
<span class="linenr"> 26: </span>Hello world!
<span class="linenr"> 27: </span>
<span class="linenr"> 28: </span>&gt;&gt; ../bake -f Bakefile1                   # build again but there's no action needed
<span class="linenr"> 29: </span>bake: file 'hello' is up to date
<span class="linenr"> 30: </span>
<span class="linenr"> 31: </span>&gt;&gt; rm hello                               # delete hello program
<span class="linenr"> 32: </span>
<span class="linenr"> 33: </span>&gt;&gt; cp Bakefile1 Bakefile                  # copy to the default name 'Bakefile'
<span class="linenr"> 34: </span>
<span class="linenr"> 35: </span>&gt;&gt; ../bake                                # build using default 'Bakefile'
<span class="linenr"> 36: </span>bake: updating 'hello' via 1 command(s)
<span class="linenr"> 37: </span>gcc -o hello hello.c 
<span class="linenr"> 38: </span>bake complete, 1 update(s) performed
<span class="linenr"> 39: </span>
<span class="linenr"> 40: </span>&gt;&gt; ../bake                                # again, rebuilding need take no action
<span class="linenr"> 41: </span>bake: file 'hello' is up to date
<span class="linenr"> 42: </span>
<span class="linenr"> 43: </span>&gt;&gt; cat Bakefile3                          # show a more complex Bakefile
<span class="linenr"> 44: </span># this is a leading comment
<span class="linenr"> 45: </span>
<span class="linenr"> 46: </span># this target uses the program that is built
<span class="linenr"> 47: </span># and runs it printing messages around it
<span class="linenr"> 48: </span>demo : hello bye
<span class="linenr"> 49: </span>	@ echo Running programs
<span class="linenr"> 50: </span>	./hello
<span class="linenr"> 51: </span>	./bye
<span class="linenr"> 52: </span>	@ echo Done running programs
<span class="linenr"> 53: </span>
<span class="linenr"> 54: </span>all : hello bye
<span class="linenr"> 55: </span>
<span class="linenr"> 56: </span># this is program 1 / 2
<span class="linenr"> 57: </span>hello : hello.o
<span class="linenr"> 58: </span>	gcc -o hello hello.o
<span class="linenr"> 59: </span>
<span class="linenr"> 60: </span>hello.o : hello.c
<span class="linenr"> 61: </span>	gcc -c hello.c
<span class="linenr"> 62: </span>
<span class="linenr"> 63: </span># this is program 2 / 2
<span class="linenr"> 64: </span>bye : bye.o
<span class="linenr"> 65: </span>	gcc -o bye bye.o
<span class="linenr"> 66: </span>
<span class="linenr"> 67: </span>bye.o : bye.c
<span class="linenr"> 68: </span>	gcc -c bye.c
<span class="linenr"> 69: </span>
<span class="linenr"> 70: </span># this target removes built files
<span class="linenr"> 71: </span>clean :
<span class="linenr"> 72: </span>	rm -f hello.o bye.o hello bye
<span class="linenr"> 73: </span>
<span class="linenr"> 74: </span># END OF THE Bakefile3
<span class="linenr"> 75: </span>
<span class="linenr"> 76: </span>&gt;&gt; ../bake -f Bakefile3 clean             # clean up any targets that exist
<span class="linenr"> 77: </span>bake: updating 'clean' via 1 command(s)
<span class="linenr"> 78: </span>rm -f hello.o bye.o hello bye 
<span class="linenr"> 79: </span>bake complete, 1 update(s) performed
<span class="linenr"> 80: </span>
<span class="linenr"> 81: </span>&gt;&gt; ../bake -f Bakefile3 all               # build with a named target 'all'
<span class="linenr"> 82: </span>bake: updating 'hello.o' via 1 command(s)
<span class="linenr"> 83: </span>gcc -c hello.c 
<span class="linenr"> 84: </span>bake: updating 'hello' via 1 command(s)
<span class="linenr"> 85: </span>gcc -o hello hello.o 
<span class="linenr"> 86: </span>bake: updating 'bye.o' via 1 command(s)
<span class="linenr"> 87: </span>gcc -c bye.c 
<span class="linenr"> 88: </span>bake: updating 'bye' via 1 command(s)
<span class="linenr"> 89: </span>gcc -o bye bye.o 
<span class="linenr"> 90: </span>bake: updating 'all' via 0 command(s)
<span class="linenr"> 91: </span>bake complete, 5 update(s) performed
<span class="linenr"> 92: </span>
<span class="linenr"> 93: </span>&gt;&gt; ../bake -f Bakefile3                   # build with the default 1st target 'demo'
<span class="linenr"> 94: </span>bake: updating 'demo' via 4 command(s)
<span class="linenr"> 95: </span>Running programs
<span class="linenr"> 96: </span>./hello 
<span class="linenr"> 97: </span>Hello world!
<span class="linenr"> 98: </span>./bye 
<span class="linenr"> 99: </span>See you, space cowboy
<span class="linenr">100: </span>Done running programs
<span class="linenr">101: </span>bake complete, 1 update(s) performed
<span class="linenr">102: </span>
<span class="linenr">103: </span>&gt;&gt; ../bake -f Bakefile3 clean             # clean up the build
<span class="linenr">104: </span>bake: updating 'clean' via 1 command(s)
<span class="linenr">105: </span>rm -f hello.o bye.o hello bye 
<span class="linenr">106: </span>bake complete, 1 update(s) performed
<span class="linenr">107: </span>
<span class="linenr">108: </span>&gt;&gt; ../bake -f Bakefile3 bye               # build the target 'bye'
<span class="linenr">109: </span>bake: updating 'bye.o' via 1 command(s)
<span class="linenr">110: </span>gcc -c bye.c 
<span class="linenr">111: </span>bake: updating 'bye' via 1 command(s)
<span class="linenr">112: </span>gcc -o bye bye.o 
<span class="linenr">113: </span>bake complete, 2 update(s) performed
<span class="linenr">114: </span>
<span class="linenr">115: </span>&gt;&gt; ./bye                                  # run bye program
<span class="linenr">116: </span>See you, space cowboy
<span class="linenr">117: </span>
<span class="linenr">118: </span>&gt;&gt; ../bake -f Bakefile3 no-target         # show the behavior on a missing target
<span class="linenr">119: </span>No rule to create target 'no-target'
<span class="linenr">120: </span>bake failed
<span class="linenr">121: </span>
<span class="linenr">122: </span>&gt;&gt; ../bake -f Bakefile3 all               # build everything
<span class="linenr">123: </span>bake: updating 'hello.o' via 1 command(s)
<span class="linenr">124: </span>gcc -c hello.c 
<span class="linenr">125: </span>bake: updating 'hello' via 1 command(s)
<span class="linenr">126: </span>gcc -o hello hello.o 
<span class="linenr">127: </span>bake: updating 'all' via 0 command(s)
<span class="linenr">128: </span>bake complete, 3 update(s) performed
<span class="linenr">129: </span>
<span class="linenr">130: </span>&gt;&gt; ../bake -f Bakefile3 all               # verify no updates are needed
<span class="linenr">131: </span>bake: nothing to be done for target 'all'
<span class="linenr">132: </span>
<span class="linenr">133: </span>&gt;&gt; touch -d '-1min' hello hello.o         # change timestamp on program / .o
<span class="linenr">134: </span>&gt;&gt; touch hello.c                          # to be older than the source file
<span class="linenr">135: </span>
<span class="linenr">136: </span>&gt;&gt; ../bake -f Bakefile3 all               # bake deteces the need to update hello but not bye
<span class="linenr">137: </span>bake: updating 'hello.o' via 1 command(s)
<span class="linenr">138: </span>gcc -c hello.c 
<span class="linenr">139: </span>bake: updating 'hello' via 1 command(s)
<span class="linenr">140: </span>gcc -o hello hello.o 
<span class="linenr">141: </span>bake: updating 'all' via 0 command(s)
<span class="linenr">142: </span>bake complete, 3 update(s) performed
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3f2c0ef" class="outline-2">
<h2 id="org3f2c0ef"><span class="section-number-2">4</span> <b>Problem 1</b>: Service Functions for Bake</h2>
<div class="outline-text-2" id="text-4">
<p>
The functions here are meant to acquaint students with some of the
data types and functionalities required in Bake. None of the functions
is terribly long and should be considered a "warm-up" for later work.
</p>
</div>

<div id="outline-container-org1f5e265" class="outline-3">
<h3 id="org1f5e265"><span class="section-number-3">4.1</span> Slurping Files</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Code is provided in <code>bake_create_from_file()</code> to parse a Bakefile and
create a <code>bake_t</code> from its contents. This requires that the entire
file be loaded into memory via a "slurp". This will be provided by the
following function.
</p>
<div class="org-src-container">
<pre class="src src-c">char *slurp_file_efficient(char *fname);
// PROBLEM 1: Uses combination of stat() and read() to efficiently
// read in the entire contents of a file into a malloc()'d block of
// memory, null terminates it (\0). Returns a pointer to the file data
// or NULL if the file could not be opened.
</pre>
</div>
<p>
As the documentation suggests, the goal here is efficiency. 
</p>
<ul class="org-ul">
<li>Make use of the <code>stat()</code> system call to determine the size of the
file in bytes and use a single <code>malloc()</code> to allocate enough space
for it</li>
<li>Use an <code>open()</code> call and as few <code>read()</code> calls as possible to read
the entire contents of the file into the allocated memory</li>
</ul>

<p>
While in many cases it is not efficient to read the entire contents of
a file into memory, Bakefiles tend to a have a memory footprint that
is similar to the int-memory data structure reflecting the file
contents so this approach is justified.
</p>
</div>
</div>

<div id="outline-container-org84508a0" class="outline-3">
<h3 id="org84508a0"><span class="section-number-3">4.2</span> Looking up and Adding Rules</h3>
<div class="outline-text-3" id="text-4-2">
<p>
The main data of Bakefiles is stored in the <code>bake_t</code> <code>rules[]</code>
array. Two functions are needed to interact with this array sensibly:
</p>
<div class="org-src-container">
<pre class="src src-c">rule_t *bake_target_rule(bake_t *bake, char *targname);
// PROBLEM 1: Searches bake for a rule with a target that equals
// `targname`. If found, returns a pointer to that rule. Otherwise
// returns NULL if no rule with target `targname` exists.
//
// DESIGN NOTE: The curent design makes use of linear search for
// target location, O(rule_count) for each lookup. Maintainting a hash
// table of target-&gt;rule key/vals would allow O(1) lookup for rules
// with given target names.

rule_t *bake_add_empty_rule(bake_t *bake);
// PROBLEM 1: Modifies `bake` to add a new, empty rule to it and
// returns a pointer to that rule. If bake-&gt;rules[] is full
// (rule_capacity and rule_count are equal) doubles the size of
// rules[] via realloc() in order create room at its end for the new
// empty rule. Returns a pointer to the new empty rule.
//
// CLARIFICATION: This function intitalizes all the date in the
// returned rule to NULL or 0 including the nested arrays. HINT: make
// use of the memset() to quickly initialize the entire rule_t struct
// to 0's. This is possible due to the nested arrays being within the
// rule_t rather than pointers to other blocks of memory which means a
// single memset() call will suffice.
// 
// CAUTION: Calling this function MAY invalidate any pointers to
// existing rules as the array that houses the rules may move.
// This sequence is dangerous:
//   rule_t *rule  = bake_target_rule(bake, "sometarget");
//   rule_t *empty = bake_add_empty_rule(bake);
//   rule may now point to de-allocated memory
</pre>
</div>
<p>
The first function allows a rule associated with a target to be
located programmatically. As the Design Note mentions, adjusting to
use a hash table would make the overall operation more efficient but a
simple linear search is sufficient for now.
</p>

<p>
The second function allows expansion of the array to a new rule. This
is used during parsing and when adding Implicit rules in the next
function.
</p>
</div>

<div id="outline-container-org3e3e450" class="outline-4">
<h4 id="org3e3e450"><a id="orge27c191"></a> Clarifications on <code>bake_add_empty_rule()</code></h4>
<div class="outline-text-4" id="text-org3e3e450">
<p>
The layout a <code>bake_t</code> contains an <code>rules[]</code> field which is
<code>malloc()</code>'d but has additional capacity. This means that adding a
rule is usually just finding the next "open" array slot: if
<code>rule_count==5</code>, then index 5 of the <code>rules[]</code> array is currently
empty.  The exception is if <code>rule_count == rule_capacity</code> in which
case the <code>rules[]</code> array is filled. In this situation, the typical
regime is
</p>
<ul class="org-ul">
<li>Allocate a new, larger array (twice as big in this case)</li>
<li>Copy over elements from the current array to the new one</li>
<li>Adjust pointers to point at the new array</li>
<li>De-allocate the original array</li>
</ul>
<p>
This is a common usage pattern that the <a href="http://man.he.net/?topic=realloc&amp;section=all"><code>realloc()</code> function</a>
covers. Making use of <code>realloc()</code> or its kin <code>reallocarray()</code> is
encouraged for this situation as it will greatly simplify the code.
</p>

<p>
When returning an "empty" rule, <code>bake_add_empty_rule()</code> is expected to
initialized all data in the rule to either 0 or NULL. This amounts to
filling the <code>rule_t</code> struct with 0's. This can be done by hand with
assignments like <code>rules[index].target = NULL;</code> but is better delegated
to the <a href="http://man.he.net/?topic=memset&amp;section=all"><code>memset()</code> function</a> which is present to fill a block of memory
with a constant byte, often 0's.  
</p>
</div>
</div>
</div>

<div id="outline-container-org741ef1e" class="outline-3">
<h3 id="org741ef1e"><span class="section-number-3">4.3</span> Adding Implicit Rules</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Rules that appear in Bakefiles are Explicit in that they are written
down. For example there are 3 rules in the below Bakefile.
</p>
<div class="org-src-container">
<pre class="src src-makefile">progA : src1.o src2.o		# EXPLICIT RULE 1
	gcc src1.o src2.o

src1.o : src1.c			# EXPLICIT RULE 2
	gcc -c src1.c

src2.o : src2.c			# EXPLICIT RULE 3
	gcc -c src2.c
</pre>
</div>
<p>
However, there is also an <b>Implicit Rule</b> that the files <code>src1.c</code> and
<code>src2.c</code> must be present. If they are not, builds will fail.
</p>

<p>
To make the data <code>bake_t</code> structure more regular, these Implicit rules
will be added. This is somewhat equivalent to re-writing the Bakefile
above as
</p>
<div class="org-src-container">
<pre class="src src-makefile">progA : src1.o src2.o		# EXPLICIT RULE 1
	gcc src1.o src2.o

src1.o : src1.c			# EXPLICIT RULE 2
	gcc -c src1.c

src2.o : src2.c			# EXPLICIT RULE 3
	gcc -c src2.c

src1.c :			# IMPLICIT RULE 4

src2.c :			# IMPLICIT RULE 5
</pre>
</div>
<p>
so that the Bakefile actually has 5 rules. 
</p>

<p>
Implicit rules have no dependencies and are marked with a special
<code>RULE_IMPLICIT_BIT</code> in their <code>rule_flags</code> field. This allows them to
behave slightly differently during builds: implicit rules always
succeed unless the file named as the target is missing.
</p>

<p>
When working with bits in the flag fields of structs, you are
encouraged to use the following 3 macros which are provided in the
<code>bake.h</code> header. This will make your code more readable and less
error-prone. 
</p>
<div class="org-src-container">
<pre class="src src-c">// Macros to deal with bits in flags
#define SET_BIT(flag,   bitmask) (flag |=  bitmask)
#define CLEAR_BIT(flag, bitmask) (flag &amp;= ~bitmask)
#define CHECK_BIT(flag, bitmask) (flag &amp;   bitmask)
</pre>
</div>


<p>
When a Bakefile is loaded, initially it only has Explicit rules in it.
The following required will be called after loading to add Implicit
rules.
</p>
<div class="org-src-container">
<pre class="src src-c">int bake_add_implicit_rules(bake_t *bake);
// PROBLEM 1: Iterate over all rules appending implicit rules for any
// dependency that is not an explicit target. New rules added in this
// way are marked with the RULE_IMPLICIT_BIT.
//
// CAUTION: Since bake-&gt;rules[] may expand, care must be taken when
// referencing rules in this function to avoid inadvertently derefing
// a pointer to free()'d memory.
</pre>
</div>
</div>
</div>

<div id="outline-container-org564bc01" class="outline-3">
<h3 id="org564bc01"><span class="section-number-3">4.4</span> Printing Commands</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Aside from <code>rule_t</code> structs, the other major struct is <code>cmd_t</code>. This
struct encodes a command to run including aspects such as
</p>
<ul class="org-ul">
<li><p>
The <b>Tokens</b> for the command: a command like 
</p>
<pre class="example">
gcc -o program -g file1.c file2.c
</pre>

<p>
would have a <code>tokens[]</code> array that looks like
</p>
<pre class="example">
tokens[] = {"gcc","-o","program","-g","file1.c","file2.c",NULL}
</pre>

<p>
Tokens will serve the role of <code>argv[]</code> when <code>exec()</code>'ing the
command. 
</p></li>
<li>Whether or not the command is "silenced": started with the <code>@</code>
symbol in the source file which suppresses printing. This is in
<code>cmd_flags</code> as presence/absence of <code>CMD_SILENCE_BIT</code>.</li>
<li>Whether to redirect input or output for the command. These attributes
show up in the fields <code>input_redirect / output_redirect</code> and within
<code>cmd_flags</code>.</li>
<li>The source file line the command came from, useful when reporting
errors.</li>
</ul>

<p>
Commands are printed when the are run unless silenced and the
following function is responsible for formatting them.
</p>
<div class="org-src-container">
<pre class="src src-c">void bake_print_cmd(cmd_t *cmd);
// PROBLEM 1: If the SILENCE_BIT is set, does nothing and immediately
// returns. Otherwise, prints the given command token by token. If I/O
// redirects are indicated by the fields of the command, prints the
// after all tokens with "&lt; infile" for input followed by "&gt; outfile"
// if present. This function is used to print out commands in
// bake_execute_cmd().
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4a037e2" class="outline-2">
<h2 id="org4a037e2"><span class="section-number-2">5</span> <b>Problem 2</b>: Executing Commands</h2>
<div class="outline-text-2" id="text-5">
<p>
It is typical during builds to run commands that may compile code,
transform inputs, or run tests. The <code>cmd_t</code> struct encodes a single
command to run. It is used to execute the command and then check the
results.
</p>
<ul class="org-ul">
<li>If the command is successful, further commands may be run and
dependent targets can be updated</li>
<li>If the command fails, then it is likely the build cannot
proceed. Any dependent targets should be notified that they NOT run
their commands.</li>
</ul>

<p>
The central function of this problem executes commands.
</p>
<div class="org-src-container">
<pre class="src src-c">int bake_execute_cmd(cmd_t *cmd);
// PROBLEM 2: Called during bake_do_update(). Prints the command using
// bake_print_cmd() unless its SILENCE bit is set. fork()'s a child
// process which exec's the command specified in cmd-&gt;tokens.  Sets up
// I/O redirection in child process if indicated by cmd flags and
// fields. Uses a wait() call to wait until the child process is
// done. If the child completes normally, its exit code is passed up,
// 0 or non-zero. If the child process fails to complete normally or
// prints an error message with line number of command
// CMD_NONSTAND_EXIT. Non-zero returns from this function will usually
// be handled in a build by cancelling the build whil 0 return will
// cause the build to prceed and execute subsequent commands.
//
// During Input and Output redirection, if the requrested files cannot
// be opened, the child process exits with code CMD_FAIL_INPREDI or
// CMD_FAIL_OUTREDI. Additionally, if the child fails to exec() a
// command, CMD_FAIL_EXEC is used as its return code. All of these are
// non-zero and trigger builds to fail. In the above failure cases,
// prints one of the below error messages appropriate to the error.
// 
// perror("ERROR: can't open file for output")
// perror("ERROR: can't open file for output")
// perror("ERROR: job failed to exec");
</pre>
</div>
</div>

<div id="outline-container-org2c96b36" class="outline-3">
<h3 id="org2c96b36"><span class="section-number-3">5.1</span> Fork / Exec / Wait</h3>
<div class="outline-text-3" id="text-5-1">
<p>
As the documentation indicates, the central idea of the function is to
<code>fork()</code> a child process to execute the command.
</p>

<p>
The child will <code>exec()</code> the command described in the <code>cmd_t tokens[]</code>
array.  <code>tokens[0]</code> can be used as a command name like <code>gcc</code> with the
entirety of <code>tokens[]</code> comprising an <code>argv[]</code> for the command to be
executed.
</p>

<p>
The parent process <code>bake</code> will <code>wait()</code> for this child to finish its
execution then check the status of its completion. If the child exists
normally and has a 0-return code, it will have completed successfully
and the function returns 0. If things go wrong, a non-zero value is
returned.
</p>
</div>
</div>

<div id="outline-container-orga560ae9" class="outline-3">
<h3 id="orga560ae9"><span class="section-number-3">5.2</span> Setting Up I/O Redirection</h3>
<div class="outline-text-3" id="text-5-2">
<p>
If the fields / flags for the command indicate as much, Input and/or
Output redirection for the command should be set up.  This needs to
occur <b>only in the child process</b> and should happen prior to an
<code>exec()</code> call.
</p>
<ul class="org-ul">
<li>Input redirection will alter Standard Input to read from a file
named in <code>cmd-&gt;input_redirect</code></li>
<li>Out redirection will alter Standard Output to write to a file
named in <code>cmd-&gt;output_redirect</code></li>
</ul>

<p>
The <code>dup2()</code> system call is useful for this and should be reviewed as
it has been presented in lab and lecture.
</p>
</div>
</div>

<div id="outline-container-org3677ae5" class="outline-3">
<h3 id="org3677ae5"><span class="section-number-3">5.3</span> Failure Detection</h3>
<div class="outline-text-3" id="text-5-3">
<p>
There are a number of things that can go wrong in a child process that
need to be detected and reported. Specific error messages and return
codes are required for each of the following situations. Each
condition is something that the child process may detect. When these
arise, the child should print the indicated message with <code>perror()</code>
and call the <code>exit(ERRCODE)</code> function to immediately exit with the
specified Error Code. The parent process will pass this Error Exit
Code up as its return value. In the case that a child command has a
non-standard exit (e.g. segfault) this will be detected in the parent
which does not print anything but does return the indicated error code.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Situation</th>
<th scope="col" class="org-left">In</th>
<th scope="col" class="org-left">Error Code</th>
<th scope="col" class="org-left"><code>perror()</code> Message</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Input Redirection Fails</td>
<td class="org-left">Child</td>
<td class="org-left"><code>CMD_FAIL_INPREDI</code></td>
<td class="org-left"><code>ERROR: can't open file for input</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Output Redirection Fails</td>
<td class="org-left">Child</td>
<td class="org-left"><code>CMD_FAIL_OUTREDI</code></td>
<td class="org-left"><code>ERROR: can't open file for output</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Exec Fails</td>
<td class="org-left">Child</td>
<td class="org-left"><code>CMD_FAIL_EXEC</code></td>
<td class="org-left"><code>ERROR: command failed to exec</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Nonstandard Child Exit Detected</td>
<td class="org-left">Parent</td>
<td class="org-left"><code>CMD_NONSTAND_EXIT</code></td>
<td class="org-left">None</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


<div id="outline-container-org0a5fe93" class="outline-2">
<h2 id="org0a5fe93"><span class="section-number-2">6</span> <b>Problem 3</b>: Walking the Bake DAG</h2>
<div class="outline-text-2" id="text-6">
<p>
This problem implements two functions responsible for traversing the
structure within a Bakefile and detecting if targets need to be
updated.  The traversal is necessarily recursive: fileA may be the
initial target but depends on fileB which in turn depends fileC. If
fileC needs to be updated, then fileB and fileA will too. The
technical term of the underlying data structure Bakefiles encode is a
<a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">Directed Acyclic Graph (DAG)</a> and is the abstract data type of choice
for representing dependencies. The data type is
</p>
<ul class="org-ul">
<li>A mathematical Graph as it is comprised of vertices and edges (nodes
and the lines between them)</li>
<li>Directed as the edges (lines) between vertices (nodes) have a
direction: fileA depends on fileB, usually drawn as a line from
fileB to fileA or "do fileB first then you can do fileA".</li>
<li>Acyclic in that there should be no cycles / circles on following
edges. A cycle of dependencies like "fileA depends on fileB depends
on fileC depends on fileA" would make it impossible to know which
file should be updated first. Checking for cyclic dependencies will be
part of the Makeup credit in the final release phase.</li>
</ul>

<div class="org-center">

<div id="orga771573" class="figure">
<p><img src="makefile-dag.png" alt="makefile-dag.png" style="max-width:100%;" />
</p>
<p><span class="figure-number">Figure 1: </span>A drawing of a Bakefile / Makefile DAG (Directed Acyclic Graph); DAG's are similar to trees BUT vertices/nodes may have multiple parents.</p>
</div>
</div>


<p>
The two required functions for this problem traverse the DAG embedded
in a Bakefile but perform two separate actions on it.
</p>
<div class="org-src-container">
<pre class="src src-c">int bake_set_updates(bake_t *bake, char *targname);
// PROBLEM 3: Starting at `targname`, recurses down the
// target/dependency DAG setting the UPDATE bit in rule_flags to
// indicate whether a target requires updates. Makes use of the
// CLEAR_BIT(), CHECK_BIT(), and SET_BIT() macros when dealing with
// bit-manipulations. For a given rule, first visits all its
// dependencies to check if they require updates via recursion. Then
// determines if `targname` requires an update. The conditions that
// require an update are described in detail in the program
// specification and shoudl be consulted while implementing this
// function. Returns 1 if target needs to be updated so associated
// rule commands should be run later. Returns 0 if the named target
// does not need to be updated. Prints an error if targname is not
// found and returns -1. If any dependency returns -1, an error
// ocurred lower down the DAG. In case, nothing is printed nothing and
// -1 is returned up the nested recursion.

int bake_do_updates(bake_t *bake, char *targname);
// PROBLEM 3: Starting at `targname`, run commands if the UPDATE bit
// is set. Before running commands associated with `targname`,
// recursively visit dependencies and if their UPDATE bit is set, run
// their commands first. Returns number of rules that were updated or
// -1 to indicate an error ocurred while running commands.
</pre>
</div>
</div>

<div id="outline-container-orgf658743" class="outline-3">
<h3 id="orgf658743"><span class="section-number-3">6.1</span> Recursing on Bake Structs</h3>
<div class="outline-text-3" id="text-6-1">
<p>
The essence of both <code>bake_set_updates()</code> and <code>bake_do_updates()</code> is to
start at some target in the Bake DAG, possibly visit all of its
dependencies via recursion, then perform some actions on the current
target before returning. This style of recursive code will be familiar
to those who have programmed <a href="https://en.wikipedia.org/wiki/Tree_traversal">Tree Traversals</a> before: it is a
"post-order traversal" but adapted to a DAG rather than a tree.
</p>

<ul class="org-ul">
<li><code>bake_set_updates(bake,target)</code>: Determine if the <code>RULE_UPDATE_BIT</code>
should be set for this target's rule as it needs its commands run to
update it. If any dependency needs an update, this target also needs
an update. If no decencies need updates, then this target may need
to be updated based on a few other factors.</li>
<li><code>bake_do_updates(bake,target)</code>: If this target's rule has its
<code>RULE_UPDATE_BIT</code> set, recurse on all its dependencies updating
them, then run the commands on the current rule to update it.</li>
</ul>
<p>
In both cases, the general outline of the functions will be akin to
the following:
</p>
<div class="org-src-container">
<pre class="src src-text">bake_recursive_func(bake, target):
  check that target is in the rules[] array of bake
  if not, return print "No rule to create target XXX" and return -1 for an error

  Perform some initial checks / actions on the current rule

  Loop over all dependencies calling bake_recursive_func() on them
  Capture the return values of recursive call on each dependency
  Use those returns to potentially take further action on the current target

  return whether or not action was taken on the current target
</pre>
</div>

<p>
There are details to be filled in for vagaries like "initial checks"
and "take further action" but the overall structure of both function
is similar and will follow the above template. Remaining sections
provide details.
</p>
</div>
</div>

<div id="outline-container-orgaf1043a" class="outline-3">
<h3 id="orgaf1043a"><span class="section-number-3">6.2</span> Setting Update Flags</h3>
<div class="outline-text-3" id="text-6-2">
<p>
<code>bake_set_updates(bake,target)</code> must determine whether to set the
<code>RULE_UPDATE_BIT</code> in the <code>rule_flags</code> field of a rule to indicate that
the rule's commands should be run to update it. Alternatively, the
analysis may instead leave that bit clear in which case the target is
already up to date and the commands need not be run.  Here are the
conditions that should be checked to determine whether to set
<code>RULE_UPDATE_BIT</code>.
</p>
<ol class="org-ol">
<li>By default, rules should NOT require an Update unless one of the
following things is true.</li>
<li><p>
If the rule is Implicit (<code>RULE_IMPLICIT_BIT</code> is set), then it does
not need to be updated. Implicit rules correspond to some file that
is dependency of an Explicit rule.  An exception to this is if the
Implicit rule target file is missing: <code>fileA.c</code> is the target of
the rule as it is needed by some other target but there is no
<code>fileA.c</code> in the build directory.  Check for the presence of the
target file and if it is missing, print the error message
</p>
<pre class="example">
No rule to create target 'XXX'
</pre>

<p>
with XXX replaced by the target file. then return -1.
</p></li>
<li>Recursively call <code>bake_set_updates()</code> on each dependency of the
given target. 
<ul class="org-ul">
<li>If any of these dependencies returns -1 for an error, pass this
up the recursion</li>
<li>If any dependency returns a 1 to indicate it requires an update,
then the current rule requires and update so set the
<code>RULE_UPDATE_BIT</code>.</li>
<li>Finally, for each dependency, check whether the dependency is a
file and the target is a file. If both are, compare their
timestamps. If the dependency is Newer than the target, the
target will require an update. See the additional information on
modification times below.</li>
</ul></li>
<li><p>
Check if the current target is a file. If not and there are
commands to run, those commands might create the target or achieve
some other effect so it requires an update. A typical example is a
<code>clean</code> target
</p>
<div class="org-src-container">
<pre class="src src-makefile">clean : 
	rm -f file1.o file2.o program
</pre>
</div>
<p>
There are no dependencies that require checking and no actual file
called <code>clean</code> that is created. The intent is that typing <code>bake
   clean</code> will always remove any of the mentioned files so it always
needs an update.
</p></li>
</ol>

<p>
At the end of <code>bake_set_updates()</code>, return a 1 if the
<code>RULE_UPDATE_BIT</code> was set for the current target or a 0 if it was not.
</p>
</div>
</div>


<div id="outline-container-org045c4fa" class="outline-3">
<h3 id="org045c4fa"><span class="section-number-3">6.3</span> Dealing with Files and Modification Times</h3>
<div class="outline-text-3" id="text-6-3">
</div>
<div id="outline-container-org9a74861" class="outline-4">
<h4 id="org9a74861">Checking Presence of Files</h4>
<div class="outline-text-4" id="text-org9a74861">
<p>
At several places in <code>bake_set_updates()</code> one must check whether a
file exists. For example a rule like
</p>
<div class="org-src-container">
<pre class="src src-makefile">x.o : x.c
	gcc -c x.c
</pre>
</div>
<p>
will need to check for the presence of both <code>x.o</code> and <code>x.c</code> at some
point. 
</p>

<p>
The <code>access()</code> system call is useful for this. It has been
demonstrated in a recent lab and should be used to check if a file is
present. The return value of <code>access()</code> will be a 0 to indicate
success in accessing an existing file or -1 if an error occurred and a
file could not be accessed, usually because it does not exist.
</p>
</div>
</div>

<div id="outline-container-org674d211" class="outline-4">
<h4 id="org674d211">Comparing File Modification Times</h4>
<div class="outline-text-4" id="text-org674d211">
<p>
The <code>stat()</code> system call should be used to get information such as
modification times for files.  <code>stat()</code> fills in a <code>struct stat sb</code>
struct with information on the file. The Modification time is present
in the fields of the <code>stat</code> struct usually in two fields.
</p>
<ul class="org-ul">
<li><code>long st_mtime</code> : this old-school field gives the modification time
to 1-second resolution.  While present, modern systems provide a
higher resolution modification time.</li>
<li><code>struct timespec st_mtim</code> : this struct provides full Nanosecond
resolution of modification times. It is slightly less easy to use at
a <code>timespec</code> struct has several fields but is favored because it
gives time at a higher fidelity.</li>
</ul>

<p>
Extract the <code>st_mtim</code> field after a stat call as it is the
higher-resolution timestamp. To compare two timestamps, make use of
the <code>diff_timespec(a,b)</code> function provided in <code>bake_util.c</code>.  
</p>
<div class="org-src-container">
<pre class="src src-c">long diff_timespec(struct timespec a, struct timespec b);
// returns difference in times between a-b; positive return means a is
// newer than b; negative indicates b is newer than a
</pre>
</div>
<p>
The function is similar in spirit to <code>strcmp()</code>: it gives a sorting
order for the two complex pieces of data passed to it.
</p>

<p>
The curious coder may look at the body of this function which shows
how the fields of the <code>timespec</code> are used to determine the ordering.
</p>
</div>
</div>
</div>

<div id="outline-container-org438f2b7" class="outline-3">
<h3 id="org438f2b7"><span class="section-number-3">6.4</span> Performing Updates</h3>
<div class="outline-text-3" id="text-6-4">
<p>
After determining whether each rule in a DAG should be updated or not,
the <code>bake_do_updates(bake,function)</code> can be used to recurse through
the bake DAG and execute any commands that are required to update
targets.  This process is again recursive: before performing a given
target's commands, its dependencies should checked as if they need to
be updated, their commands should be run first. A set of rules like
the following make this apparent.
</p>
<div class="org-src-container">
<pre class="src src-makefile">program : prog.o
	gcc -o program prog.o

prog.o : prog.c
	gcc -c prog.c
</pre>
</div>
<p>
If <code>prog.o</code> does not exist, then the first command <code>gcc -o program
prog.o</code> would fail. Instead, the commands associated with the
dependency should be run first to create this file. Then <code>program</code> can
be created.  
</p>

<p>
Calls to <code>bake_do_updates()</code> assume that the <code>RULE_UPDATE_BIT</code> in each
<code>rule_flag</code> is set or clear (1 or 0) according to whether a rule needs
its commands updated or not. Usually this would happen a <code>main()</code>
function by first calling <code>bake_set_updates()</code> and then calling
<code>bake_do_updates()</code>. 
</p>

<p>
Here is the general flow of <code>bake_do_updates(bake,target)</code>:
</p>
<ul class="org-ul">
<li>Check if the <code>RULE_UPDATE_BIT</code> is set for <code>target</code>; if not, there is
nothing to be done so return immediately</li>
<li>Recursively call <code>bake_do_updates()</code> on all dependencies of the
current target</li>
<li><p>
Print out the message
</p>
<pre class="example">
bake: updating 'XXX' via NNN command(s)
</pre>

<p>
where <code>XXX</code> is the target being updated and <code>NNN</code> is the number of
commands that will be run to update it
</p></li>
<li>Finally, execute all commands associated with the target using
<code>bake_execute_cmd()</code>.</li>
<li>Any errors that occur in the above should trigger an immediate
return of -1 for from the function. That includes:
<ul class="org-ul">
<li><code>target</code> isn't found</li>
<li>Any dependency returns an error</li>
<li>Any Command that executes fails or results in a non-zero Exit Code</li>
</ul></li>
</ul>

<p>
Before returning, Clear the <code>RULE_UPDATE_BIT</code> from this rule to
indicate that the target for the rule is now up to date. By setting
<code>RULE_UPDATE_BIT</code> to 0, if this rule is ever visited again, the
commands will not be repeated. An example of this appears in the next
paragraph. 
</p>

<p>
The return value of <code>bake_do_updates()</code> is the number of targets are
updated (i.e. rules that have their commands run).  This can be
accomplished by 
</p>
<ul class="org-ul">
<li>Returning 0 if a target does not need to be updated</li>
<li>Summing the return values of all dependencies (but not -1 for
errors)</li>
<li>Adding one to the sum of updates after the commands for the current
rule are run and then returning that sum</li>
</ul>

<p>
Below is an example Bakefile to demonstrate with calls to <code>bake</code> to
sho the idea of the returning the total number of updates and avoiding
executing the same rule twice.
</p>
<div class="org-src-container">
<pre class="src src-makefile">all : prog1 prog2


prog1 : x.o y.o
	gcc -o prog1 x.o y.o

prog2 : x.o z.o
	gcc -o prog2 x.o z.o

x.o : x.c
	gcc -c x.c

y.o : y.c
	gcc -c y.c

z.o : z.c
	gcc -c z.c
</pre>
</div>

<p>
Here is the behavior of running <code>bake</code> on this Bakefile
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt;&gt; ../bake
bake: updating 'x.o' via 1 command(s)
gcc -c x.c 
bake: updating 'y.o' via 1 command(s)
gcc -c y.c 
bake: updating 'prog1' via 1 command(s)
gcc -o prog1 x.o y.o 
bake: updating 'z.o' via 1 command(s)
gcc -c z.c 
bake: updating 'prog2' via 1 command(s)
gcc -o prog2 x.o z.o 
bake: updating 'all' via 0 command(s)
bake complete, 6 update(s) performed
</pre>
</div>
<ul class="org-ul">
<li>6 total updates are done, one for each rule</li>
<li>Each update corresponds to one rule and its target</li>
<li><code>prog1</code> is updated first which means <code>x.o</code> must be created.</li>
<li>Running <code>gcc -c x.c</code> creates <code>x.o</code>; having completed target <code>x.o</code>,
the <code>RULE_UPDATE_BIT</code> in its <code>rule_flags</code> will be cleared to
indicate it is up to date.</li>
<li><code>prog2</code> also needs <code>x.o</code> BUT since <code>x.o</code> is up to date, there is no
need to re-run any commands to create it. On visiting the <code>x.o</code>
rule, its <code>RULE_UPDATE_BIT</code> is NOT set so no commands are run</li>
<li>Even though the target <code>all</code> has no commands run, it still counts as
an update.</li>
</ul>
</div>

<div id="outline-container-org5a7fcad" class="outline-4">
<h4 id="org5a7fcad">Output and Error Messages</h4>
<div class="outline-text-4" id="text-org5a7fcad">
<p>
Below is a table of output messages for <code>bake_set_updates()</code> and
<code>bake_do_updates()</code> along with the conditions under which they should 
be printed.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Message</th>
<th scope="col" class="org-left">Condition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>No rule to create target '%s'</code></td>
<td class="org-left">Printed if a target cannot be found in the rules array which returns an error</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>Implicit rule cannot find file 'XXX'</code></td>
<td class="org-left">Printed if an Implicit Rule has it's file missing which results in an error: example:. <code>file.c</code> is</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">listed as a dependency but there is no <code>file.c</code> available.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>bake: updating 'XXX' via NNN command(s)</code></td>
<td class="org-left">Printed before running commands to update target <code>XXX</code>, <code>NNN</code> is the number of commands to be run</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>FFF:LLL ERROR during target 'XXX', exit code NNN</code></td>
<td class="org-left">Printed when a command to update <code>XXX</code> fails,</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">gives the file <code>FFF</code> and line number <code>LLL</code> of the command along with the exit code <code>NNN</code></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


<div id="outline-container-orgb0ecb97" class="outline-2">
<h2 id="orgb0ecb97"><span class="section-number-2">7</span> <b>Problem 4</b>: Postprocessing and Main</h2>
<div class="outline-text-2" id="text-7">
<p>
The final steps to completing the Bake application are to do a bit of
post-processing on the Bakefile contents before tying all functionality
together in a <code>main()</code> function.
</p>
</div>

<div id="outline-container-org5c2b329" class="outline-3">
<h3 id="org5c2b329"><span class="section-number-3">7.1</span> Post Processing</h3>
<div class="outline-text-3" id="text-7-1">
<p>
To make parsing a Bakefile reasonable, only a minimal amount of
processing of its raw contents are done before shuffling them into a
<code>bake_t</code> struct.  Then intent is then to <b>post-process</b> this data
structure to modify its contents based on supported features. This
could include a variety of things including
</p>
<ul class="org-ul">
<li>Translating automatic and named variables to their values</li>
<li>Instituting pattern-based rules</li>
<li>Inclusion of other source files</li>
<li>etc.</li>
</ul>

<p>
For the simplest version of Bake, only one item is addressed in
post-processing: <b>modify each Command</b> so that if it includes I/O
redirection or command silencing, the associated <code>cmd_t</code> struct is
modified to reflect this. Post-processing of commands are handled by the
following function.
</p>
<div class="org-src-container">
<pre class="src src-c">int bake_cmd_postprocess(bake_t *bake, cmd_t *cmd);
// PROBLEM 4: Examines cmd-&gt;tokens to set cmd-&gt;flags and a few other
// fields. Used to post-process the raw tokens of a command. Likely
// uses the utility function array_shift() to ease the re-arrangment
// of arrays.
// 
// 1. If tokens[0] = "@", eliminates this token by shifting all tokens
// over and sets the SILENCED bit
// 
// 2. If tokens[i] = "&lt;", input redirection is desired; if tokens[i+1]
// is not NULL, returns -1. Otherwise sets the INPREDI bit and
// input_redirect field to tokens[i+1]. Then shifts all tokens over to
// eliminate tokens[i] and tokens[i+1].
// 
// 3. If tokens[i] = "&gt;", output redirection is desired and performs
// similar operations to #2 with the OUTREDI flag and output_redirect
// fields.
//
// Correctly handles any order of "&lt; input" / "&gt; output" and other
// tokens (ex: output redirection may appear first followed by normal
// tokens followed by input redirection)
// 
// If multiple "&lt;" or "&gt;" tokens appear, the behavior of this function
// is unspecified: it may return an error, segfault, or behave randomly.
// 
// Returns 0 on succesful completion.
//
// DESIGN NOTE: This function must be called prior to any commands
// being run. The ideal location is during parsing to modify commands
// as a bake_t structure is built. However, this functionality is
// separated out to enable future functionality such as variable
// substitution to be added to commands and tested separately from
// parsing. Any additional context needed for such things will be part
// of the 'bake' parameter (e.g. may contain a map of variable
// names/values for substitutions).
</pre>
</div>

<p>
An example Bakefile is useful to understand the intent of this function.
</p>
<div class="org-src-container">
<pre class="src src-makefile">prog : dep1.c dep2.c
	cat dep1.c dep2.c &gt; deps.c        # cmd0
	@ echo Counting lines in deps.c   # cmd1
	wc -l &lt; deps.c                    # cmd2
	gcc -o prog deps.c                # cmd3
</pre>
</div>
<p>
The comments like <code># cmd0</code> are technically not legal in a Bakefile but
make it easier to reference the necessary transformations.
</p>
</div>



<div id="outline-container-org2288c66" class="outline-4">
<h4 id="org2288c66">cmd0 Example</h4>
<div class="outline-text-4" id="text-org2288c66">
<pre class="example">
cat dep1.c dep2.c &gt; deps.c        # cmd0
</pre>

<ul class="org-ul">
<li>This command indicates Output Redirection is needed</li>
<li>The raw <code>cmd-&gt;tokens[]</code> array will be
<code>{"cat","dep1.c","dep2.c","&gt;","deps.c",NULL}</code></li>
<li><code>bake_cmd_postprocess()</code> will detect the <code>"&gt;"</code> token and set the
<code>cmd-&gt;output_redirect</code> field to be <code>deps.c</code> as will as set the
<code>CMD_OUTREDI_BIT</code> in <code>cmd-&gt;cmd_flags</code>.</li>
<li>The <code>tokens[]</code> array will then be altered remove the output
redirection tokens so that it appears as
<code>{"cat","dep1.c","dep2.c",NULL}</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgf45ffed" class="outline-4">
<h4 id="orgf45ffed">cmd1 Example</h4>
<div class="outline-text-4" id="text-orgf45ffed">
<pre class="example">
@ echo Counting lines in deps.c   # cmd1
</pre>

<ul class="org-ul">
<li>This command indicates command printing should be Silenced</li>
<li>The raw <code>cmd-&gt;tokens[]</code> array will be
<code>{"@", "echo", "Counting", "lines", "in", "deps.c", NULL}</code></li>
<li><code>bake_cmd_postprocess()</code> will detect the <code>"@"</code> as the 0th token and
set the set the <code>CMD_SILENCE_BIT</code> in <code>cmd-&gt;cmd_flags</code>.</li>
<li>The <code>tokens[]</code> array will then be altered remove the <code>@</code> token so
that it appears as <code>{"echo", "Counting", "lines", "in", "deps.c", NULL}</code></li>
</ul>
</div>
</div>

<div id="outline-container-org37d82b2" class="outline-4">
<h4 id="org37d82b2">cmd2 Example</h4>
<div class="outline-text-4" id="text-org37d82b2">
<pre class="example">
wc -l &lt; deps.c                    # cmd2
</pre>

<ul class="org-ul">
<li>This command indicates Input Redirection is needed</li>
<li>The raw <code>cmd-&gt;tokens[]</code> array will be
<code>{"wc","-l","&lt;","deps.c",NULL}</code></li>
<li><code>bake_cmd_postprocess()</code> will detect the <code>"&lt;"</code> token and set the
<code>cmd-&gt;input_redirect</code> field to be <code>deps.c</code> as will as set the
<code>CMD_INPREDI_BIT</code> in <code>cmd-&gt;cmd_flags</code>.</li>
<li>The <code>tokens[]</code> array will then be altered remove the input
redirection tokens so that it appears as
<code>{"wc","-l",NULL}</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgde88aab" class="outline-4">
<h4 id="orgde88aab">cmd3 Example</h4>
<div class="outline-text-4" id="text-orgde88aab">
<pre class="example">
gcc -o prog deps.c                # cmd3
</pre>

<p>
No modifications need be made to this command as it does not have any
I/O redirection or silencing.
</p>
</div>
</div>

<div id="outline-container-org1d67bb8" class="outline-4">
<h4 id="org1d67bb8">Re-arranging Token Arrays</h4>
<div class="outline-text-4" id="text-org1d67bb8">
<p>
The <code>array_shift()</code> function from ~bake<sub>utils.c</sub>~* is useful for
re-arranging arrays to remove tokens in the . However, <b>be careful</b>
when using this function. Try it in a limited setting to ensure that
you understand how to use it properly.
</p>

<div class="org-src-container">
<pre class="src src-c">void array_shift(char *strs[], int delpos, int maxlen);
// shift the array of strings left by 1 starting at delpos; eliminates
// delpos from the array.
</pre>
</div>
</div>
</div>


<div id="outline-container-org2f93018" class="outline-4">
<h4 id="org2f93018">Post-Processing All Commands</h4>
<div class="outline-text-4" id="text-org2f93018">
<p>
<code>bake_cmd_postprocess()</code> is called in a loop in the following
function.
</p>
<div class="org-src-container">
<pre class="src src-c">void bake_post_process(bake_t *bake);
// PROBLEM 4: Applies postprocessing operations to the bake after
// loading it from a file. Currently only iterates over all rules and
// applies bake_cmd_postprocess() to each of their commands.
//
// DESIGN NOTE: This function is where additional operations could be
// used to further modify the bakefile such as performing variable
// substitutions on rules / targets, including other bakefiles. etc.
</pre>
</div>
<p>
As the design note indicates, other transformations of the <code>bake_t</code>
may be added here as the functionality of Bake expands but for now it
is a relatively short set of nested loops to post-process commands. 
</p>
</div>
</div>
</div>

<div id="outline-container-org38826b5" class="outline-3">
<h3 id="org38826b5"><span class="section-number-3">7.2</span> Main Function</h3>
<div class="outline-text-3" id="text-7-2">
<p>
The final step in constructing Bake is to provide a <code>main()</code> function
in <code>bake_main.c</code> which sequences all the previous functionality
properly. 
</p>
</div>

<div id="outline-container-org3c5c8e3" class="outline-4">
<h4 id="org3c5c8e3">Command Line options</h4>
<div class="outline-text-4" id="text-org3c5c8e3">
<p>
For convenience, <code>bake</code> will look for a default <code>Bakefile</code>
just as <code>make</code> looks for a file named <code>Makefile</code>. Alternatively, a
command line option allows for the specification of a specific file to
use. IN addition, Bake supports denoting a target to build the command
line just as Make does.
</p>

<p>
The following are example usages that must be supported.
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt;&gt; bake                         
# use default "Bakefile" and 1st target in that file

&gt;&gt; bake all
# use Bakefile but build target "all" rather than 1st target

&gt;&gt; bake -f Bakefile2         
# use Bakefile2 with 1st target in that file

&gt;&gt; bake -f Bakefile2 all
# use Bakefile2 but build target "all" rather than 1st target

&gt;&gt; bake all -f Bakefile2         
# NOT SUPPORTED and not tested

&gt;&gt; bake -f NoFile
Couldn't open file: No such file or directory
ERROR: unable to process file 'NoFile'
# Example error message for when a requested Bakefile cannot be found
</pre>
</div>
<p>
Note that your <code>main()</code> function will need to support each of the
cases above except the NOT SUPPORTED command line
structure. Conveniently, each of the supported cases has 1, 2, 3, and
4 command line arguments respectively which can make the analyzing
these cases easier.
</p>
</div>
</div>

<div id="outline-container-orgcaf32ec" class="outline-4">
<h4 id="orgcaf32ec">Outline of <code>main()</code> Logic</h4>
<div class="outline-text-4" id="text-orgcaf32ec">
<p>
Below is a suggested outline of how the <code>main()</code> function might flow
and make use of the previous functions.
</p>
<div class="org-src-container">
<pre class="src src-text"><span class="linenr"> 1: </span>main:
<span class="linenr"> 2: </span>  process the command line arguments to determine if the default Bakefile or some other 
<span class="linenr"> 3: </span>    file should be loaded
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span>  load the requested Bakefile int a bake_t struct
<span class="linenr"> 6: </span>  if the load fails, 
<span class="linenr"> 7: </span>    print "ERROR: unable to process file 'XXX'" 
<span class="linenr"> 8: </span>    substituting in the filename and exit the program with EXIT_FAILURE
<span class="linenr"> 9: </span>
<span class="linenr">10: </span>  if the loaded file has no rules in it (empty)
<span class="linenr">11: </span>    print "ERROR: 'XXX' has 0 rules
<span class="linenr">12: </span>    and exit with EXIT_FAILURE
<span class="linenr">13: </span>
<span class="linenr">14: </span>  Add implict rules to the bake_t
<span class="linenr">15: </span>  Post-process the bake_t
<span class="linenr">16: </span>
<span class="linenr">17: </span>  If a target like "all" or "clean" was specified on the command line
<span class="linenr">18: </span>    set that as the target to update
<span class="linenr">19: </span>    otherwise set the 0th rule target as the one to update
<span class="linenr">20: </span>
<span class="linenr">21: </span>  Analyze the bake_t starting at the specified target to set which
<span class="linenr">22: </span>    targets need to be updated
<span class="linenr">23: </span>
<span class="linenr">24: </span>  If the update analysis fails
<span class="linenr">25: </span>    print "bake failed" and exit with a failure
<span class="linenr">26: </span>
<span class="linenr">27: </span>  If the update analysis indicates the target does not need to be updated
<span class="linenr">28: </span>    Check if the target is an existing file
<span class="linenr">29: </span>      If so, print the message "bake: file 'XXX' is up to date"
<span class="linenr">30: </span>      If not, print the mssage "bake: nothing to be done for target 'XXX'"
<span class="linenr">31: </span>    Then return/exit with a 0 exit code for a successful build
<span class="linenr">32: </span>
<span class="linenr">33: </span>  Since some targets need to be updated, recursively run comands to update
<span class="linenr">34: </span>    dependencies and targets counting the total number of rule updates
<span class="linenr">35: </span>
<span class="linenr">36: </span>  If updates fail (perhaps due to commands failing)
<span class="linenr">37: </span>    print the message "bake failed" and exit with EXIT_FAILURE
<span class="linenr">38: </span>
<span class="linenr">39: </span>  Otherwise, on a successful update, print the message
<span class="linenr">40: </span>    "bake complete, NNN update(s) performed" 
<span class="linenr">41: </span>    substituting in the number of updates (rules with commands run)
<span class="linenr">42: </span>  
<span class="linenr">43: </span>  return 0 for success
</pre>
</div>
<p>
A few notes on this overview
</p>
<ul class="org-ul">
<li>While somewhat long, many of the lines above just translate to calls
to previously written functions like <code>bake_add_implicit_rules()</code> or
<code>bake_do_updates()</code></li>
<li><b>When exiting you may need to free memory</b> to prevent a memory
leak. <code>bake_util.c</code> provides <code>bake_free()</code> to de-allocate the memory
associated with a <code>bake_t</code> and its nested data. Note carefully the
Exit cases above as many of them will require freeing memory.</li>
<li><p>
At various points when errors are detected in the Bake process, the
overview indicates "exit with <code>EXIT_FAILURE</code>".  This is accomplished
in one of two ways.
</p>
<ul class="org-ul">
<li>By <code>return EXIT_FAILURE;</code> from <code>main()</code></li>
<li>By calling the C standard <code>exit(EXIT_FAILURE)</code> function from
anywhere</li>
</ul>
<p>
The constants <code>EXIT_FAILURE</code> (usually defined to be 1) and
<code>EXIT_SUCCESS</code> (usually defined to be 0) are defined in included
headers and may be used to convey a bit more semantic meaning about
failure/success than just writing constants 1/0.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org48876f3" class="outline-4">
<h4 id="org48876f3">Main Output and Error Messages</h4>
<div class="outline-text-4" id="text-org48876f3">
<p>
The following table lists some of the expected output and error
messages that <code>main()</code> will produce and the conditions associated with
them.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Message</th>
<th scope="col" class="org-left">Conditions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>ERROR: unable to process file 'XXX'</code></td>
<td class="org-left">Requested Bakefile failed to load properly</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>ERROR: '%s' has 0 rules</code></td>
<td class="org-left">Requested Bakefile had no rules in it</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>bake failed</code></td>
<td class="org-left">Printed when errors occurred during <code>bake_set_updates()</code> or <code>bake_do_updates()</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>bake: file 'XXX' is up to date</code></td>
<td class="org-left">No updates needed for <code>XXX</code> and it is an accessible file</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>bake: nothing to be done for target 'XXX'</code></td>
<td class="org-left">No updates needed for <code>XXX</code> and it is NOT an accessible file</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>bake complete, NNN update(s) performed</code></td>
<td class="org-left">Successful completion, substitute <code>NNN</code> for the number of updates performed</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<div id="outline-container-org717193f" class="outline-2 grading 100">
<h2 id="org717193f"><span class="section-number-2">8</span> Grading Criteria&#xa0;&#xa0;&#xa0;<span class="tag"><span class="grading">grading</span>&#xa0;<span class="100">100</span></span></h2>
<div class="outline-text-2" id="text-8">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Weight</th>
<th scope="col" class="org-left">Criteria</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">AUTOMATED TESTS: 1 point per test</td>
</tr>

<tr>
<td class="org-right">50</td>
<td class="org-left">TOTAL</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">Problem 1: <code>make test-prob1</code> runs tests from <code>test_prob1.org</code> for correctness</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">Problem 2: <code>make test-prob2</code> runs tests from <code>test_prob2.org</code> for correctness</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">Problem 3: <code>make test-prob3</code> runs tests from <code>test_prob3.org</code> for correctness</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">Problem 4: <code>make test-prob3</code> runs tests from <code>test_prob4.org</code> for correctness</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><i>Note: Problem 3 &amp; 4 tests are not part of the initial project release.</i></td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">MANUAL INSPECTION</td>
</tr>

<tr>
<td class="org-right">50</td>
<td class="org-left">TOTAL</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left"><b>PROBLEM 1 <code>bake_funcs.c</code></b></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>slurp_file_efficient()</code>: Clear use of <code>stat</code> to determine size of file and single <code>malloc()</code> used</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>slurp_file_efficient()</code>: Detecting failure to <code>open()</code> files and reporting appropriately</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>bake_target_rule()</code>: Iteration over <code>bake_t</code> data structure, use of <code>strcmp()</code></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>bake_add_empty_rule()</code>: Identifies full array and uses <code>realloc()</code> to double size of array</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>bake_add_implicit_rule()</code>: Correct iteration across rules array and dependencies for rules</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>bake_add_implicit_rule()</code>: Use of <code>bake_add_empty_rule()</code> function to add rules</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>bake_add_implicit_rule()</code>: Use of and <code>SET_BIT()</code> macro to adjust implicit bit in flags</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>bake_print_cmd()</code>: <code>CHECK_BIT()</code> macro used to inspect <code>SILENCE_BIT</code>, clear code to print I/O redirects</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">CODE STYLE</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Sane indentation, reasonable variable naming</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Presence of commentary to guide readers through complex code</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left"><b>PROBLEM 2 <code>bake_funcs.c</code> <code>bake_execute_cmd()</code></b></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Use of <code>bake_print_cmd()</code> to output command if needed</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Use of <code>fork()</code> to create a child process, code split between parent/child</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Parent uses <code>wait() / waitpid()</code> to block until child is done, identifies normal/abnormal child exit</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Child sets up input/output redirection via <code>dup2()</code></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Chile uses an <code>exec()</code>-family function to execute the given command</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Child does error checking for failure of I/O redirection or exec and returns appropriate Exit Codes</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">CODE STYLE</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Sane indentation, reasonable variable naming</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Presence of commentary to guide readers through complex code</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Presence of commentary to guide readers through complex code</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left"><b>PROBLEM 3 <code>bake_funcs.c</code></b></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><i>CRITERIA FOR <code>bake_set_updates() / bake_do_updates()</code></i></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Utilize bit macros like <code>SET_BIT() / CHECK_BIT()</code> for bit flag manipulations</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Utilize previous functions like <code>bake_target_rule()</code> to access <code>bake_t</code> data</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><i>CRITERIA FOR <code>bake_set_updates()</code> uses clear structure to visit all dependencies recursively</i></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Uses clear structure to visit all dependencies recursively</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Uses updates on dependencies to dictate whether a given target needs an update</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Handles special case of Implicit rules: target file must be present, no updates required</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Utilizes the <code>access()</code> system call check presences/absence of target files</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Utilizes the <code>stat()</code> system call to get timestamp information on target/dependency files</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><i>CRITERIA FOR <code>bake_do_updates()</code></i></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Has a clear recursive structure to update dependencies before a given target</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Iterates over all commands using <code>bake_execute_cmd()</code> to run them when an update is needed</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Checks the return code of each command and terminates with an error if commands fail</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Clears the UPDATE bit after updating a target to ensure that the rule is updated only once</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">CODE STYLE</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Sane indentation, reasonable variable naming</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Presence of commentary to guide readers through complex code</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Presence of commentary to guide readers through complex code</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left"><b>PROBLEM 4 <code>bake_funcs.c</code> and <code>bake_main.c</code></b></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><i>CRITERIA FOR <code>bake_cmd_post_process()</code> in <code>bake_funcs.c</code></i></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Has cases to handle each of input redirection, output redirection, and silencing commands</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Handles command array re-arrangement reasonably, likely through use of <code>array_shift()</code></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><i>CRITERIA FOR <code>main()</code> in <code>bake_main.c</code></i></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Clear command line handling logic to detect <code>-f &lt;bakefile&gt;</code> option and command line target like <code>all</code></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Code to use the default file <code>Bakefile</code> if no command line file is specified</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Use of <code>bake_create_from_file()</code> to load a Bakefile with Error checking to ensure it was loaded</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Use of <code>bake_funcs.c</code> functions like <code>bake_add_implicit_rules</code> and <code>bake_post_process()</code> after loading</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Handles case of no target being specified on the command line and defaults to the 0th rule target</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Utilizes <code>bake_set_updates()</code> to analyze the desired target and detect if updates are needed</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Utilizes <code>bake_do_updates()</code> to update the targets when needed</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Checks for error returns (-1) from various functions, de-allocates memory if so and exits with <code>EXIT_FAILURE</code></td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">CODE STYLE</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Sane indentation, reasonable variable naming</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Presence of commentary to guide readers through complex code</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Presence of commentary to guide readers through complex code</td>
</tr>
</tbody>
</table>
</div>
</div>



<div id="outline-container-orgc56213a" class="outline-2">
<h2 id="orgc56213a"><span class="section-number-2">9</span> <a id="orge10853c"></a> Problem 5: Optional Makeup Credit</h2>
<div class="outline-text-2" id="text-9">
<p>
The data structure that Bakefiles are meant to encode is a DAG with
the "A" indicating "acyclic" - no cycles of target/dependencies. There
is no way to enforce this in the text file format that constitutes
Bakefiles so a sloppy writer may create the following:
</p>
<div class="org-src-container">
<pre class="src src-makefile"># cycle of A-&gt;B-&gt;C-&gt;A
fileA.txt : fileB.txt
	@ echo completed fileA.txt

fileB.txt : fileC.txt
	@ echo completed fileB.txt

fileC.txt : fileA.txt
	@ echo completed fileC.txt
</pre>
</div>

<p>
Such structure is sometimes referred to as a <b>cyclic dependency</b>.
The best that programs like Bake can do is to analyze the data
provided to detect such cycles and bail out before inadvertently
entering an infinite recursion.
</p>

<p>
For 10 points of MAKEUP CREDIT add cyclic dependency checks to your
implementation of Bake. This will require 2 major changes:
</p>
<ol class="org-ol">
<li>Implement a top-level service function in <code>bake_funcs.c</code> that
detects cycles</li>
<li>Call that function in <code>main()</code> before performing recursive
operations on a loaded <code>bake_t</code> structure</li>
</ol>

<p>
Below are details on aspects of this Makeup problem.
</p>
</div>

<div id="outline-container-org07ef9eb" class="outline-4">
<h4 id="org07ef9eb"><a id="org20b29f5"></a> MAKEUP CREDIT</h4>
<div class="outline-text-4" id="text-org07ef9eb">
<p>
MAKEUP CREDIT are additional points that allow students to exceed the
total of points possible for the project. These points go into the
overall pool of points earned on projects and will make up for lost
credit on this or other projects.
</p>

<p>
MAKEUP CREDIT is NOT EXTRA CREDIT: student scores on the project
portion of the course will not exceed 100%. However, MAKEUP CREDIT
allows for students to ensure they get full project credit even with
some mistakes.
</p>
</div>
</div>

<div id="outline-container-org1b01790" class="outline-3">
<h3 id="org1b01790"><span class="section-number-3">9.1</span> <code>bake_check_cycles()</code></h3>
<div class="outline-text-3" id="text-9-1">
<p>
Add the following top-level function to <code>bake.h</code> and your own
<code>bake_funcs.c</code>. 
</p>

<div class="org-src-container">
<pre class="src src-c">int bake_check_cycles(bake_t *bake, char *targname, int do_print);
// PROBLEM 5 MAKEUP: Analyzes `bake` starting at targname to
// deteremine if any cycles are present which would create problems
// completing a build: if targA depends on targB depends an targA, a
// cyclcil dependency exists and could not be fulfilled.  Returns 1 if
// a cycle is present, 0 if no cycle is present, and -1 if an error
// occurs such as not finding a needed target.
//
// If do_print is non-zero, prints out a message like:
// 
//   ERROR Cyclic Dependency detected:
//   fileA.txt -&gt; fileB.txt -&gt; fileC.txt -&gt; fileA.txt
// 
// where the first line is always identical and the second line shows
// the path from the initial target through a cycle. Implementations
// assume that these messages will fit in a 2048-byte array and have
// undefined behavior if the message is larger.
//
// NOTES: This function needs to initiate a recursive descent into
// `bake` via a helper function which does the brunt of the work.
// This helper function may be defined in whatever way with whatever
// prototype is convenient. Global variables may be used to help
// generate cycle message BUT implementations with pride will find
// ways to avoid the use of global variables.
</pre>
</div>

<ul class="org-ul">
<li>As NOTES suggestion you will need to add one ore more additional
recursive "helper" functions that are called by
<code>bake_check_cycles()</code>.  You may add functions of whatever sort you
wish to <code>bake_funcs.c</code>: defining them above <code>bake_check_cycles()</code>
in the C file will make them available for use in that function.</li>
<li>Identifying when cycles occur is only a modestly complex recursive
problem. Make use of the <code>RULE_VISITED_BIT</code> for <code>rule_flags</code> as you
recursively descend through rules. Employ a similar strategy as your
<code>bake_set_updates()</code> function though take care to adapt to the
current usage: don't blindly copy all aspects of the previous
pattern.</li>
<li>Creating the ERROR message with the detected cycle is the trickiest
aspect of the problem.  Typical strategies will grow a string with
each recursive call and then "shrink" it in some fashion as the
recursion unwinds. You may find the <code>sprintf()</code> function useful in
this context and the fact that strings can be ended by placing a
<code>\0</code> character in it.  You may use global variables for your
implementation if you can't figure out a way around doing so BUT
know it is not difficult to do without them.</li>
</ul>
</div>
</div>

<div id="outline-container-org4e6c83e" class="outline-3">
<h3 id="org4e6c83e"><span class="section-number-3">9.2</span> Bake <code>main()</code> for Cycle Checking</h3>
<div class="outline-text-3" id="text-9-2">
<p>
After completing the <code>bake_check_cycles()</code> function, add a call to it
in your <code>bake_main.c</code> code in <code>main()</code>.  Place the call prior to any
other recursive calls. If the cyclic dependency check fails, exit with
<code>EXIT_FAILURE</code>.
</p>
</div>
</div>

<div id="outline-container-org4955e8b" class="outline-3">
<h3 id="org4955e8b"><span class="section-number-3">9.3</span> Problem 5 Grading Criteria</h3>
<div class="outline-text-3" id="text-9-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Weight</th>
<th scope="col" class="org-left">Criteria</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">5</td>
<td class="org-left">AUTOMATED TESTS:</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>make test-prob5</code> runs tests from <code>test_prob5.org</code> for correctness</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Several tests for <code>bake_check_cycles()</code> and <code>main()</code> augmented for cycle detection</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">1 point per test</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">MANUAL INSPECTION</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>bake_check_cycles()</code> uses a recursive helper function that is present and documented</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Recursive helper function has a clear structure of base and recursive cases</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Recursive helper function contains clear creation of an ERROR message tracking a cyclic path</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left"><code>main()</code> contains an active call to <code>bake_check_cycles()</code> with early exit on a failure</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">TOTAL</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


<div id="outline-container-org7449691" class="outline-2">
<h2 id="org7449691"><span class="section-number-2">10</span> Assignment Submission</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-orgdbd9d3a" class="outline-3">
<h3 id="orgdbd9d3a"><span class="section-number-3">10.1</span> <a id="org3256773"></a> Submit to Gradescope</h3>
<div class="outline-text-3" id="text-10-1">
<p>
Refer to the Project 1 instructions and adapt them for details of how
to submit to Gradescope. In summary they are
</p>

<ol class="org-ol">
<li>Type <code>make zip</code> in the project directory to create <code>p4-comlete.zip</code></li>
<li>Log into <a href="https://www.gradescope.com/">Gradescope</a>, select Project 4, and upload <code>p4-complete.zip</code></li>
</ol>
</div>
</div>

<div id="outline-container-orge0a6195" class="outline-3">
<h3 id="orge0a6195"><span class="section-number-3">10.2</span> Late Policies</h3>
<div class="outline-text-3" id="text-10-2">
<p>
You may wish to review the policy on late project submission which
will cost 1 Engagement Point per day late. <b>No projects will be
accepted more than 48 hours after the deadline.</b>
</p>


<p>
<a href="https://www.cs.umd.edu/~profk/216/syllabus.html#late-submission">https://www.cs.umd.edu/~profk/216/syllabus.html#late-submission</a>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<hr/> <i> <a href="https://www.umd.edu/web-accessibility" title="UMD Web Accessibility">Web Accessibility</a> <br/> Author: Chris Kauffman (<a href="mailto:profk@umd.edu">profk@umd.edu</a>) <br/> Date: 2024-04-22 Mon 18:39 <br/> </i>
</div>
</body>
</html>
