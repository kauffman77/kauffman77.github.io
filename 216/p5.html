<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-12-06 Wed 10:06 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CMSC216 Project 5: Performance Opt and Threading</title>
<meta name="author" content="Chris Kauffman" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<meta name="viewport" content="width=device-width, maximum-scale=1, minimum-scale=1" />
<style type="text/css">
@media screen {
:root {
--heading-bg-color:#e21833;
--heading-fg-color:#ffd200;
}
html {
font-family: serif;
text-align: justify;
}
pre.src, pre.example {
overflow-x: scroll;
}
/* Merge subtitle area with title area */
.subtitle {
text-align: center;
margin-top: -2em;
padding-top: 1em;
padding-bottom: 0.1em;
}
.title, .subtitle {
color: var(--heading-fg-color);
background-color: var(--heading-bg-color);
}
/* Section borders, left section header style */
div.outline-2, #table-of-contents {
background-color: rgb(250,250,250);
border: 0.75em solid var(--heading-bg-color);
border-top: 0em;
padding: 0em .5em .5em .5em; /* top right bottom left */
margin: 1em 0em 1em 0em; /* top right bottom left */
}
div.outline-2 > h2, #table-of-contents > h2 {
background-color: var(--heading-bg-color);
color: var(--heading-fg-color);
font-variant: small-caps;
padding: 0em 0em 0em .5em; /* top right bottom left */
margin: 0em -.5em 0em -.75em; /* top right bottom left */
text-align: left;
}
blockquote {
font-style: italic;
}
td, th {
padding-top: 2px;
padding-bottom: 2px;
}
body {
background-color: #EEE;
}
pre {
}
#content, #preamble, #postamble {
margin-left:300px;
max-width: 100%;
}
.tag {
background-color: inherit; font-family: inherit;
padding: inherit; font-size: 80%; font-weight: inherit;
text-transform: uppercase;
}

.figure p { text-align: inherit; }
figure-number { font-style: italic; }
#table-of-contents {
text-align: left;
position: fixed;
left: 0;
margin: 0 auto;
padding: 0;
width: 300px;
top: 0;
height: 100%;
border: 0;
display: block;
}
#text-table-of-contents {
overflow-y: scroll;
height: 100%;
}
#text-table-of-contents ul {
padding-left: 1em;
margin-left: 0.5em;
}
#table-of-contents > h2 {
padding: 0.1em;
margin: 0;
}
/* adjustments for small screen, toc at top only */
@media (max-width: 800px) { /* landscape for iphone */
html {
-webkit-text-size-adjust: none;  /* prevent scaling of text on mobile */
}
body {
background-color: #EEE;
width:100%;
margin:0 auto;
}
#content, #preamble, #postamble {
margin-left:0;
}
#table-of-contents {
position: static;
left: inherit;
width:inherit;
height: auto;
border-top: 0em;
padding: 0em .5em .5em .5em; /* top right bottom left */
margin: 1em 0em 1em 0em; /* top right bottom left */
border: 0.75em solid #006633;
}
div.outline-2, #table-of-contents {
background-color: rgb(250,250,250);
border: 0.75em solid var(--heading-bg-color);
border-top: 0em;
padding: 0em .5em .5em .5em; /* top right bottom left */
margin: 1em 0em 1em 0em; /* top right bottom left */
}
div.outline-2 > h2, #table-of-contents > h2 {
background-color: var(--heading-bg-color);
color: var(--heading-fg-color);
font-variant: small-caps;
padding: 0em 0em 0em .5em; /* top right bottom left */
margin: 0em -.5em 0em -.75em; /* top right bottom left */
text-align: left;
}
#text-table-of-contents {
overflow-y: visible;
height: inherit;
}
#text-table-of-contents ul {
padding-left: 1em;
margin-left: 0.5em;
}
}
.linenr { font-size: xx-small; }
}

@media print {
html {
font-family: serif;
font-size: 10pt;
text-align: justify;
.linenr { font-size: xx-small; }
}
}
</style>
<style>
/* Theme: Srcery
Description: Srcery dark color scheme for highlight.js
Author: Chen Bin <chen.bin@gmail.com>
Maintainer: @redguardtoo
Website: https://srcery-colors.github.io/
Date: 2021-04-13
https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/srcery.css

Tailored by: Chris Kauffman <profk@umd.edu>
Date: Sat Nov 25 06:16:20 PM EST 2023
*/
pre code.hljs {
display: block;
overflow-x: auto;
padding: 1em
}
code.hljs {
padding: 3px 5px
}
.hljs {
background: #1C1B19;
/* Black */
color: #FFFFFF/* Bright White */

}
/* Bright White */
.hljs-subst,
.hljs-quote,
.hljs-literal {
color: #FCE8C3
}
/* Bright Blue */
.hljs-type,
.hljs-symbol {
color: #68A8E4
}
/* Red */
.hljs-keyword,
.hljs-deletion {
color: #EF2F27
}
/* Yellow */
.hljs-name,
.hljs-function,
.hljs-attribute,
.hljs-selector-attr,
.hljs-selector-id,
.hljs-selector-class,
.hljs-selector-pseudo,
.hljs-section,
.hljs-title {
color: #FBB829
}
/* Cyan */
.hljs-code,
.hljs-variable,
.hljs-property,
.hljs-template-variable,
.hljs-class {
color: #0AAEB3
}
/* Bright Green */
.hljs-string,
.hljs-regexp,
.hljs-bullet,
.hljs-addition {
color: #98BC37
}
/* Bright Magenta */
.hljs-built_in,
.hljs-params {
color: #FF5C8F
}
/* Blue */
.hljs-template-tag,
.hljs-selector-tag {
color: #2C78BF
}
/* Bright Black */
.hljs-link,
.hljs-number,
.hljs-comment,
.hljs-meta {
color: #B1B195
/* color: #918175 */
}
.hljs-emphasis {
font-style: italic
}
.hljs-strong {
font-weight: bold
}
/* @see https://github.com/srcery-colors/srcery-emacs for reference */
</style>

<link rel="stylesheet" href="./srcery-ck.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', (event) => {
function interactive_lang() {      // define a custom "interactive" language
return {
name: 'interactive',           // language name
keywords: {
$pattern: /[^ \t\n]+/,       // lex based on non-whitespace
keyword: [">>","(shellac)","homeputer>","grace10:"], // allowed interactive prompts
},
contains: [
// hljs.HASH_COMMENT_MODE,   // use standard hash comments, any # is a comment
hljs.COMMENT(/#+ /, /$/),    // use custom comment of # w/ whitespace
]
};
};
hljs.registerLanguage('interactive', interactive_lang);     // register custom language

// Add highlighjs CSS classes to elemens marked with relevant org classes
lang_map = new Map();              // map of org to hljs languages
lang_map.set("src-c"    , "language-c");
lang_map.set("src-text" , "language-plaintext");
lang_map.set("src-sh"   , "language-interactive");
function add_class(el) {           // applied to each pre.src element
for (let [org_lang, hljs_lang] of lang_map) {
if(el.classList.contains(org_lang)){
el.classList.add(hljs_lang);
}
}
}
// visit all pre.src elements and apply function to add language class
document.querySelectorAll('pre.src').forEach(add_class);
hljs.configure({cssSelector: 'pre'}); // select pre blocks only to highligh
hljs.highlightAll();                  // perform highlighting on all pre blocks
});
</script>
</head>
<body>
<div id="preamble" class="status">
<i>Last Updated: 2023-12-06 Wed 10:06</i>
</div>
<div id="content" class="content">
<h1 class="title">CMSC216 Project 5: Performance Opt and Threading</h1>
<ul class="org-ul">
<li><b>Due: 11:59pm Mon 11-Dec-2023</b></li>
<li><i>Approximately 3.0-4.0% of total grade</i></li>
<li>Submit to <a href="https://www.gradescope.com/"><b>Gradescope</b></a></li>
<li>Projects are <b>individual work</b>: no collaboration with other students
is allowed. Seek help from course staff if you get stuck for too long.</li>
</ul>

<div id="outline-container-orgf3e9d94" class="outline-4">
<h4 id="orgf3e9d94">CODE/TEST DISTRIBUTION: <a href="p5-code.zip">p5-code.zip</a></h4>
</div>
<div id="outline-container-org7aa89b9" class="outline-4">
<h4 id="org7aa89b9">Video Overview: <i>Not Yet Available</i></h4>
</div>
<div id="outline-container-orgee5dfba" class="outline-4">
<h4 id="orgee5dfba">CHANGELOG:</h4>
<div class="outline-text-4" id="text-orgee5dfba">
<dl class="org-dl">
<dt>Sat Dec  2 11:07:57 AM EST 2023</dt><dd>The initial release had an
incorrect <code>#include "matvec.h"</code> in <code>sumdiag_optm.c</code>. This should be
<code>#include "sumdiag.h"</code> instead and has been fixed in <code>p5-code.zip</code>.
Make the change manually if you have already started work on the
project.</dd>
</dl>
</div>
</div>

<div id="outline-container-org101fbad" class="outline-4">
<h4 id="org101fbad"></h4>
<div class="outline-text-4" id="text-org101fbad">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org9630325">1. Introduction</a></li>
<li><a href="#org38d6592">2. Download Code and Setup</a></li>
<li><a href="#orgdf92fca">3. <b>Problem 1</b>: Matrix Diagonal Sums</a>
<ul>
<li><a href="#org2cd9d20">3.1. Overview</a></li>
<li><a href="#org2e4442d">3.2. Optimize Diagonal Sums</a></li>
<li><a href="#org4af133a">3.3. Evaluation on Grace</a></li>
<li><a href="#org6389950">3.4. <code>sumdiag_print.c</code> Testing Program</a></li>
<li><a href="#optimizations">3.5. Optimization Suggestions and Documentation</a></li>
<li><a href="#org384acbe">3.6. Constraints</a></li>
<li><a href="#org45df174">3.7. Additional Optimizations for Makeup Credit</a></li>
<li><a href="#org4936650">3.8. Optimization Hints</a></li>
<li><a href="#org2c9ac08">3.9. Grading Criteria for Problem 1 (100%)</a></li>
</ul>
</li>
<li><a href="#orge392944">4. Writeup</a></li>
</ul>
</div>
</div>
</div>
</div>


<div id="outline-container-org9630325" class="outline-2">
<h2 id="org9630325"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
A baseline implementation for a function operating on a matrix is
provided and students will create an optimzied version of it which
calculates the same result but in a shorter time.  Doing so will
involve exploiting knowledge of the memory hierarchy to favor cache
and enabling multi-threading to further boost perforamnce.
</p>
</div>
</div>

<div id="outline-container-org38d6592" class="outline-2">
<h2 id="org38d6592"><span class="section-number-2">2</span> <a id="orgeccea08"></a> Download Code and Setup</h2>
<div class="outline-text-2" id="text-2">
<p>
Download the code pack linked at the top of the page. Unzip this which
will create a project folder. Create new files in this
folder. Ultimately you will re-zip this folder to submit it.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">File</th>
<th scope="col" class="org-left">State</th>
<th scope="col" class="org-left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>Makefile</code></td>
<td class="org-left">Provided</td>
<td class="org-left">Problem 1 &amp; 2 Build file</td>
</tr>

<tr>
<td class="org-left"><code>P5-WRITEUP.txt</code></td>
<td class="org-left">EDIT</td>
<td class="org-left">Fill in answers to assignment questions</td>
</tr>

<tr>
<td class="org-left"><code>testy</code></td>
<td class="org-left">Testing</td>
<td class="org-left">Test running script</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><code>sumdiag_optm.c</code></td>
<td class="org-left">EDIT</td>
<td class="org-left">Problem 1 create and fill in optimized function definition</td>
</tr>

<tr>
<td class="org-left"><code>sumdiag_benchmark.c</code></td>
<td class="org-left">Provided</td>
<td class="org-left">Problem 1 main benchmark</td>
</tr>

<tr>
<td class="org-left"><code>sumdiag_print.c</code></td>
<td class="org-left">Provided</td>
<td class="org-left">Problem 1 testing program</td>
</tr>

<tr>
<td class="org-left"><code>sumdiag_base.c</code></td>
<td class="org-left">Provided</td>
<td class="org-left">Problem 1 baseline function to beat</td>
</tr>

<tr>
<td class="org-left"><code>matvec.h</code></td>
<td class="org-left">Provided</td>
<td class="org-left">Problem 1 header file</td>
</tr>

<tr>
<td class="org-left"><code>matvec_util.c</code></td>
<td class="org-left">Provided</td>
<td class="org-left">Problem 1 utility functions for matrices/vectors</td>
</tr>

<tr>
<td class="org-left"><code>test_sumdiag.org</code></td>
<td class="org-left">Testing</td>
<td class="org-left">Tests to check for memory issues in problem 1</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgdf92fca" class="outline-2">
<h2 id="orgdf92fca"><span class="section-number-2">3</span> <b>Problem 1</b>: Matrix Diagonal Sums</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org2cd9d20" class="outline-3">
<h3 id="org2cd9d20"><span class="section-number-3">3.1</span> Overview</h3>
<div class="outline-text-3" id="text-3-1">
<p>
A problem that occasionally arises in numerical computing when working
with Matrices (2D Arrays) is to compute the sums of the <b>Diagonals</b> of
a matrix.  The main diagonal of a matrix is comprised of all elements
at indices (0,0), (1,1), (2,2), and so forth.  There are several
numbering schemes for diagonals but we will use the one represented in
the following diagram which also shows the sums of the diagonals.
</p>

<div class="org-center">

<div id="orge36a8fb" class="figure">
<p><img src="sumdiag.png" alt="sumdiag.png" style="max-width:100%;" />
</p>
<p><span class="figure-number">Figure 1: </span>5 by 5 matrix with diagonals colored. The diagram shows our numbering scheme for diagonals and the corresponding diagonal sums. Diagonal numbers start at 0 and progress counter-clockwise around the bottom and right of the matrix. For square matrices, the main diagonal is always numbered as the #rows-1 or #cols-1 which are equal.</p>
</div>
</div>

<p>
A code is provided in the file <code>sumdiag_base.c</code> which computes the
sums of diagonals and stores them in a vector. The algorithm does so
using the most "natural" approach of walking down each diagonal and
totaling its elements then storing the result in the associated vector
element.  As you survey the code, note the use of various convenience
functions such as <code>mget(mat,i,j)</code> and <code>vset(vec,i,x)</code> to interact with
the matrix and vector types used.
</p>

<div class="org-src-container">
<pre class="src src-c">int sumdiag_BASE_NORMAL(matrix_t *mat, vector_t *vec) {
  if(vec-&gt;len != (mat-&gt;rows + mat-&gt;cols -1)){
    printf("sumdiag_base: bad sizes\n");
    return 1;
  }
  for(int i=0; i&lt;vec-&gt;len; i++){                     // initialize vector of diagonal sums
    vset(vec,i,0);                                   // to all 0s
  }

  for(int d=0; d &lt; mat-&gt;rows; d++){                  // iterate over lower diagonals
    int c = 0;                                       // col always starts at 0 in lower diags
    for(int r=mat-&gt;rows-d-1; r&lt;mat-&gt;rows; r++,c++){  // work down rows, right cols for same diag
      int el_rc = mget(mat, r, c);                   // get matrix element on diagonal
      int vec_d = vget(vec, d);                      // retrieve current sum for diag
      vset(vec, d, el_rc+vec_d);                     // add on back to the diagonal sum
    }
  }

  int maxdiag = (mat-&gt;rows+mat-&gt;cols)-1;             // calculate last diagonal
  for(int d=mat-&gt;rows; d &lt; maxdiag ; d++){           // iterate starting at first upper diag
    int r = 0;                                       // row always starts at 0 in upper diags
    for(int c=d-mat-&gt;cols+1; c&lt;mat-&gt;cols; r++,c++){  // work down rows, right cols for same diag
      int el_rc = mget(mat, r, c);                   // matrix element
      int vec_d = vget(vec, d);                      // diagonal sum from vector
      vset(vec, d, el_rc+vec_d);                     // add on to sum
    }
  }
  return 0;                                          // return success
}
</pre>
</div>

<p>
While this algorithm is a direct translation of how humans would
visually calculate the sums of diagonals for small matrices, it is
unfortunately fairly slow when executing on most modern computing
systems.
</p>
</div>
</div>

<div id="outline-container-org2e4442d" class="outline-3">
<h3 id="org2e4442d"><span class="section-number-3">3.2</span> Optimize Diagonal Sums</h3>
<div class="outline-text-3" id="text-3-2">
<p>
The purpose of this problem is to write <code>sumdiag_OPTM()</code> which is a
faster version of the provided <code>sumdiag_BASE()</code> to calculate the sums
of diagonals.
</p>

<p>
Write your code in the file <code>sumdiag_optm.c</code>.
</p>

<p>
Keep the following things in mind.
</p>
<ol class="org-ol">
<li>You will need to acquaint yourself with the functions and types
related to matrices and vectors provided in the <code>matvec.h</code> and
demonstrated in the baseline function. Understanding the layout of
the matrix in memory is essential to unlocking performance.</li>
<li>The goal of <code>sumdiag_OPTM()</code> is to exceed the performance of
<code>sumdiag_BASE()</code> by as much as possible.</li>
<li>To achieve this goal, several optimizations must be implemented and
suggestions are given in a later section.</li>
<li>There is one additional parameter to the optimized function:
<code>sumdiag_OPTM(mat,vec,thread_count)</code>.  This indicates the number of
threads that should be used to compute diagonal sums.</li>
<li>You will need to document your optimizations in the file
<code>P5-WRITEUP.txt</code> and provide timing results of running the
optimized version.</li>
<li>Part of your grade will be based on the speed of the optimized code
on <code>grace.umd.edu</code>. The main routine <code>sumdiag_benchmark.c</code> will be
used for this.</li>
</ol>

<p>
Some details are provided in subsequent sections.
</p>
</div>
</div>

<div id="outline-container-org4af133a" class="outline-3">
<h3 id="org4af133a"><span class="section-number-3">3.3</span> Evaluation on Grace</h3>
<div class="outline-text-3" id="text-3-3">
<p>
The file <code>sumdiag_benchmark.c</code> provides a benchmark for the speed of
diagonal summing. It will be used by graders to evaluate the submitted
code and should be used during development to gauge performance
improvements.
</p>

<p>
The following machines may be used to evaluate the benchmark:
</p>
<div class="org-src-container">
<pre class="src src-text">grace.umd.edu
</pre>
</div>

<p>
The scoring present in <code>sumdiag_benchmark.c</code> is "tuned" to these
machines and will likely report incorrect results on other machines.
That means that codes should be so that no unexpected results occur
after submission. Results reported in <code>P5-WRITEUP.txt</code> should be from
one of the above machines.
</p>

<p>
The output of the <code>sumdiag_benchmark</code> is shown below.
</p>
<ul class="org-ul">
<li><code>SIZE</code>: the size of the matrix being used. The benchmark always
uses square matrices</li>
<li><code>BASE</code>: the time it takes for <code>sumdiag_BASE()</code> to complete.</li>
<li><code>#T</code>: number of threads used for running <code>sumdiag_OPTM()</code></li>
<li><code>OPTM</code>: the time it takes for <code>sumdiag_OPTM()</code> to complete.</li>
<li><code>SPDUP</code>: the speedup of <code>sumdiag_OPTM()</code> over <code>sumdiag_BASE()</code> which
is <code>BASE / OPTM</code>.</li>
<li><p>
<code>POINTS</code>: earned according to the following code:
</p>
<div class="org-src-container">
<pre class="src src-c">    double points = log(speedup_OPTM) / log(2.0) * size / 4500;
</pre>
</div>
<p>
This scheme means that unless actual optimizations are implemented,
0 points will be scored. Roughly this scores according to a
logarithmic scale that is weighted towards more points if speedups
at larger sized inputs is achieved.
</p></li>
</ul>

<p>
Below are several demonstration runs of <code>sumdiag_benchmark</code>.
</p>
<div class="org-src-container">
<pre class="src src-sh"># RUN ON INCORRECT MACHINE (NOT loginNN): NOTE WARNINGS
homeputer&gt; ./sumdiag_benchmark 
WARNING: expected host 'grace1.umd.edu' but got host 'val'
WARNING: timing results / scoring will not reflect actual scoring
WARNING: run on host 'grace1.umd.edu' for accurate results
==== Matrix Diagonal Sum Benchmark Version 4 ====
------- Tuned for grace.umd.edu machines --------
Running with 5 sizes (max 8192) and 4 thread_counts (max 4)
  SIZE   BASE #T   OPTM  SPDUP POINTS 
  1024  0.041  1  0.019   2.18   0.26 
               2  0.017   2.44   0.29 
               3  0.017   2.42   0.29 
               4  0.017   2.43   0.29 
  2048  0.208  1  0.068   3.04   0.73 
               2  0.060   3.45   0.81 
               3  0.061   3.43   0.81 
               4  0.058   3.60   0.84 
  4096  0.811  1  0.230   3.53   1.66 
               2  0.220   3.68   1.71 
               3  0.221   3.67   1.71 
               4  0.221   3.68   1.71 
  4099  0.548  1  0.226   2.42   1.16 
               2  0.222   2.47   1.19 
               3  0.225   2.43   1.17 
               4  0.223   2.45   1.18 
  8192  2.843  1  0.887   3.21   3.06 
               2  0.893   3.18   3.04 
               3  0.892   3.19   3.05 
               4  0.887   3.21   3.06 
RAW POINTS: 28.02
TOTAL POINTS: 28 / 35
WARNING: expected host 'grace1.umd.edu' but got host 'val'
WARNING: timing results / scoring will not reflect actual scoring
WARNING: run on host 'grace1.umd.edu' for accurate results

# PARTIAL CREDIT RUN
&gt;&gt; ssh grace.umd.edu
...
grace10: ./sumdiag_benchmark 
==== Matrix Diagonal Sum Benchmark Version 4 ====
------- Tuned for grace.umd.edu machines --------
Running with 5 sizes (max 8192) and 4 thread_counts (max 4)
  SIZE   BASE #T   OPTM  SPDUP POINTS 
  1024  0.027  1  0.017   1.60   0.15 
               2  0.017   1.62   0.16 
               3  0.017   1.63   0.16 
               4  0.017   1.62   0.16 
  2048  0.104  1  0.066   1.58   0.30 
               2  0.066   1.58   0.30 
               3  0.066   1.57   0.30 
               4  0.067   1.57   0.30 
  4096  0.507  1  0.273   1.86   0.82 
               2  0.284   1.79   0.76 
               3  0.288   1.76   0.75 
               4  0.274   1.85   0.81 
  4099  0.484  1  0.272   1.78   0.76 
               2  0.272   1.78   0.76 
               3  0.274   1.77   0.75 
               4  0.272   1.78   0.76 
  8192  2.991  1  1.087   2.75   2.66 
               2  1.217   2.46   2.36 
               3  1.086   2.75   2.66 
               4  1.085   2.76   2.66 
RAW POINTS: 18.32
TOTAL POINTS: 18 / 35

# FULL CREDIT RUN
grace10: ./sumdiag_benchmark 
==== Matrix Diagonal Sum Benchmark Version 4 ====
------- Tuned for grace.umd.edu machines --------
Running with 5 sizes (max 8192) and 4 thread_counts (max 4)
  SIZE   BASE #T   OPTM  SPDUP POINTS 
  1024  0.029  1  0.017   1.73   0.18 
               2  0.009   3.26   0.39 
               3  0.009   3.06   0.37 
               4  0.013   2.23   0.26 
  2048  0.124  1  0.066   1.88   0.41 
               2  0.033   3.72   0.86 
               3  0.025   4.99   1.06 
               4  0.028   4.40   0.97 
  4096  0.505  1  0.259   1.95   0.88 
               2  0.144   3.51   1.65 
               3  0.096   5.28   2.19 
               4  0.093   5.42   2.22 
  4099  0.481  1  0.297   1.62   0.63 
               2  0.132   3.65   1.70 
               3  0.096   5.02   2.12 
               4  0.099   4.85   2.07 
  8192  2.895  1  1.077   2.69   2.60 
               2  0.529   5.48   4.47 
               3  0.351   8.24   5.54 
               4  0.339   8.55   5.64 
RAW POINTS: 36.20
TOTAL POINTS: 35 / 35
</pre>
</div>

<p>
Note that it is possible to exceed the score associated with maximal
performance (as seen in the RAW POINTS reported) but no more than the
final reported points will be given for the performance portion of the
problem.
</p>

<blockquote>
<p>
Achieving very high speedup and significantly exceeding the max score
may garner some MAKEUP credit: you'll know you earned this as the
benchmark will report as much
</p>
</blockquote>
</div>
</div>


<div id="outline-container-org6389950" class="outline-3">
<h3 id="org6389950"><span class="section-number-3">3.4</span> <code>sumdiag_print.c</code> Testing Program</h3>
<div class="outline-text-3" id="text-3-4">
<p>
As one works on implementing optimizations in <code>sumdiag_OPTM()</code>, bugs
which compute incorrect results are often introduced.  To aid in
testing, the <code>sumdiag_print()</code> program runs both the BASE and OPTM
versions on the same matrix and shows all results. The matrix size is
determined from the command line and is printed on the screen to
enable hand verification. Examples are below.
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt;&gt; sumdiag_print                       # show usage: pass mat size and thread_count
usage: sumdiag_print &lt;size&gt; &lt;thread_count&gt;

&gt; ./sumdiag_print 5  1                 # run on a size 5 by 5 matrix with 1 thread
==== Matrix Diagonal Sum Print ====
Matrix:
5 x 5 matrix                           # shows the matrix
   0:    0    1    2    3    4 
   1:    5    6    7    8    9 
   2:   10   11   12   13   14 
   3:   15   16   17   18   19 
   4:   20   21   22   23   24 

Diagnonal Sums:                        # prints diag sums for BASE/OPTM
[ i]: BASE OPTM
[ 0]:   20   20                        # matching
[ 1]:   36   36 
[ 2]:   48   48 
[ 3]:   56   56 
[ 4]:   60   36 ***                    # not matching: OPTM is buggy
[ 5]:   40   21 ***
[ 6]:   24   10 ***
[ 7]:   12    3 ***
[ 8]:    4    0 ***

</pre>
</div>
</div>
</div>


<div id="outline-container-orge2d9fa4" class="outline-3">
<h3 id="optimizations"><a id="orge2d9fa4"></a><span class="section-number-3">3.5</span> <a id="org00ddd81"></a> Optimization Suggestions and Documentation</h3>
<div class="outline-text-3" id="text-optimizations">
<p>
Labs and lectures will cover several kinds of optimizations which are
useful to improve the speed of <code>sumdiag_OPTM()</code>.  Two optimizations
are required which are:
</p>
<ol class="org-ol">
<li>Re-ordering memory accesses to be as sequential as possible which
favors cache. <b>Unless memory accesses favor cache, it is unlikely
that many optimizations will have much effect.</b></li>
<li>Use threads to split up the work of calculating diagonals. The
problem parallelized well as worker threads can mostly compute
independent results before combining them with the results of other
threads.</li>
</ol>

<p>
In most cases, implementing these two correctly will yield full
performance points.
</p>

<p>
<b>Students must describe the specific techniques they used</b> for
optimizing the code in a short writeup for the project by answering
questions in <code>P5-WRITEUP.txt</code>.
</p>
</div>
</div>

<div id="outline-container-org384acbe" class="outline-3">
<h3 id="org384acbe"><span class="section-number-3">3.6</span> Constraints</h3>
<div class="outline-text-3" id="text-3-6">
</div>
<div id="outline-container-orgd172680" class="outline-4">
<h4 id="orgd172680">Use a Mutex</h4>
<div class="outline-text-4" id="text-orgd172680">
<p>
While it may be possible to implement a completely lock-free solution
with threads, <b>your implementation MUST use mutexes to coordinate
threads</b> as they access shard data in some part of the code. Credit
will be deducted if you do not illustrate use of mutexes as one of the
course goals for students to demonstrate proficiency with thread
coordination. 
</p>
</div>
</div>

<div id="outline-container-orgd5b8781" class="outline-4">
<h4 id="orgd5b8781">Avoid Global Variables</h4>
<div class="outline-text-4" id="text-orgd5b8781">
<p>
In many simple threaded programs, global variables are a convenient
way to give worker threads/functions access to shared data. <b>AVOID
THIS</b> for full credit. Use "contexts" instead: define a struct type
that contains the data necessary for a worker thread to
contribute. Then pass this struct to the worker thread on
creation. Common elements of such structs are
</p>
<ul class="org-ul">
<li>A numeric thread id</li>
<li>A total thread count</li>
<li>References (structs or pointers) to data for the computation</li>
<li>Pointers to any shared locks that are needed to coordinate access</li>
</ul>
<p>
Lecture and discussion demos will provide some examples of how this
might look 
</p>
</div>
</div>
</div>

<div id="outline-container-org45df174" class="outline-3">
<h3 id="org45df174"><span class="section-number-3">3.7</span> Additional Optimizations for Makeup Credit</h3>
<div class="outline-text-3" id="text-3-7">
<p>
Additional optimizations may be performed to further speed up the
computations. Some of these are described in Chapter 5 of
Bryant/O'Hallaron.
</p>
<ol class="org-ol">
<li>Replacing repeated memory references with local non-pointer data
which will likely be assigned to registers to alleviate slow-down
from memory accesses.</li>
<li>Increasing potential processor pipelining by adjusting the
destinations of arithmetic operations.</li>
<li>Decreasing any unnecessary work such as memory accesses or
arithmetic operations.</li>
</ol>
<p>
None of these are required. However, <b>MAKEUP Credit is available for
achieving scores that greatly exceed the original baseline version.</b>
The benchmark program will check for high scores and give an obvious
sign that makeup credit is earned.
</p>
</div>
</div>

<div id="outline-container-org4936650" class="outline-3">
<h3 id="org4936650"><span class="section-number-3">3.8</span> Optimization Hints</h3>
<div class="outline-text-3" id="text-3-8">
<ol class="org-ol">
<li>While optimizing the memory access pattern, it is handy to be able
to convert a Row/Column index to a Diagonal number (e.g. Row 3, Col
1 is in Diagonal 2).  Research or derive a formula that relates a
row/column index to its diagonal number to aid your optimization
efforts.</li>
</ol>

<ol class="org-ol">
<li>Lecture and discussion will provide examples of how to effectively
deploy threads and use a mutex to coordinate them. Draw inspiration
from those materials for your work.</li>

<li>To get the most out of thread performance, code them to compute
private partial results. This avoids any unnecessary mutex
locking. In most cases, threads will need to update a shared
variable so a mutex is needed (in fact required in your
solution). However, locking the mutex only once at the end of the
thread's work greatly benefit performance over repeated lock/unlock
approaches.</li>
</ol>
</div>
</div>


<div id="outline-container-org2c9ac08" class="outline-3 grading 100">
<h3 id="org2c9ac08"><span class="section-number-3">3.9</span> Grading Criteria for Problem 1 (100%)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="grading">grading</span>&#xa0;<span class="100">100</span></span></h3>
<div class="outline-text-3" id="text-3-9">
<p>
The file <code>P4-WRITEUP.txt</code> has several questions that should be
answered in a similar fashion to lab write-ups. These document the
optimizations used in <code>sumdiag_OPTM()</code> require a justification for
their use.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Weight</th>
<th scope="col" class="org-left">Criteria</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">AUTOMATED TESTS</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">No output/memory errors reported  <code>make test-prob1</code></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">PERFORMANCE EVALUATION</td>
</tr>

<tr>
<td class="org-right">35</td>
<td class="org-left">Performance of <code>sumdiag_OPTM()</code> on <code>grace.umd.edu</code></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">As measured by the provided <code>sumdiag_benchmark</code></td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">Best score of 3 runs done by graders after submission closes</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">MANUAL INSPECTION of <code>sumdiag_optm.c</code></td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">Effort to optimize memory access pattern in <code>sumdiag_OPTM()</code></td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">Effort to utilize threads in <code>sumdiag_OPTM()</code></td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">Clear effort to coordinate thread access to shared data using a mutex</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">Avoids the use of Global Variables in favor of local "contexts" to give threads data they need</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">Overall clean and readable style of code with supporting commenting</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">MANUAL INSPECTION of <code>P4-WRITEUP.txt</code></td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">Answer 1A <code>P4-WRITEUP.txt</code> : source code</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">Answer 1B <code>P4-WRITEUP.txt</code> : timing table</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">Answer 1C <code>P4-WRITEUP.txt</code> : memory optimization</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">Answer 1C <code>P4-WRITEUP.txt</code> : thread optimization</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



<div id="outline-container-orge392944" class="outline-2">
<h2 id="orge392944"><span class="section-number-2">4</span> Writeup</h2>
<div class="outline-text-2" id="text-4">
<p>
This assignment involves answering questions in the file
<code>P5-WRITEUP.txt</code> which is included in the code pack and pasted below.
</p>

<div class="org-src-container">
<pre class="src src-text">                              ____________

                               P5 WRITEUP
                              ____________


- Name: (FILL THIS in)
- UID: (THE kauf0095 IN kauf0095@terpmail.umd.edu)

Answer the questions below according to the project specification. Write
your answers directly in this text file and submit it along with your
code.


PROBLEM 1: sumdiag_OPTM()
=========================

  Time your code using sumdiag_benchmark on grace.umd.edu.


(A) Paste Source Code
~~~~~~~~~~~~~~~~~~~~~

  Paste a copy of your source code for the function
  `sumdiag_OPTM()'. Include any "helper" functions you used such as a
  thread worker function.

  ####################### YOUR ANSWER HERE #########################

  ##################################################################


(B) Timing on grace.umd.edu
~~~~~~~~~~~~~~~~~~~~~~~~~~~

  Paste a copy of the results of running `sumdiag_benchmark' on
  `grace.umd.edu' in the space below which shows how your performance
  optimizations improved on the baseline codes.

  ####################### YOUR ANSWER HERE #########################

  ##################################################################


(C) Memory Optimization
~~~~~~~~~~~~~~~~~~~~~~~

  Describe how your optimized the memory access pattern of the program.
  - What order did you visit matrix elements in?
  - How did relate elements in the matrix to the diagonals that belonged
    to?

  ####################### YOUR ANSWER HERE #########################

  ##################################################################


(D) Thread Optimization
~~~~~~~~~~~~~~~~~~~~~~~

  Describe how you employed threads to further increase the speed of
  your code.
  - How did you subdivide the work / matrix among the threads?
  - What coordination was required as threads would update any shared
    data?
  - How often did threads need to update shared data?

  ####################### YOUR ANSWER HERE #########################

  ##################################################################
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<hr/> <i> Author: Chris Kauffman (<a href="mailto:profk@umd.edu">profk@umd.edu</a>) <br/> Date: 2023-12-06 Wed 10:06 <br/> </i>
</div>
</body>
</html>