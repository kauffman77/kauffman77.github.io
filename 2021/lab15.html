<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-12-15 Wed 06:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSCI 2021 Lab15: Wrap-up and Review</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Chris Kauffman" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta name="viewport" content="width=device-width, maximum-scale=1, minimum-scale=1" />
<style type="text/css">
@media screen {
:root {
--heading-bg-color:#e8c62e;
--heading-fg-color:#7a0019;
}
html {
font-family: serif;
text-align: justify;
}
pre.src, pre.example {
overflow-x: scroll;
}
/* Merge subtitle area with title area */
.subtitle {
text-align: center;
margin-top: -2em;
padding-top: 1em;
padding-bottom: 0.1em;
}
.title, .subtitle {
color: var(--heading-fg-color);
background-color: var(--heading-bg-color);
}
/* Section borders, left section header style */
div.outline-2, #table-of-contents {
background-color: rgb(250,250,250);
border: 0.75em solid var(--heading-bg-color);
border-top: 0em;
padding: 0em .5em .5em .5em; /* top right bottom left */
margin: 1em 0em 1em 0em; /* top right bottom left */
}
div.outline-2 > h2, #table-of-contents > h2 {
background-color: var(--heading-bg-color);
color: var(--heading-fg-color);
font-variant: small-caps;
padding: 0em 0em 0em .5em; /* top right bottom left */
margin: 0em -.5em 0em -.75em; /* top right bottom left */
text-align: left;
}
blockquote {
font-style: italic;
}
td, th {
padding-top: 2px;
padding-bottom: 2px;
}
body {
background-color: #EEE;
}
pre {
}
#content, #preamble, #postamble {
margin-left:300px;
}
.tag {
background-color: inherit; font-family: inherit;
padding: inherit; font-size: 80%; font-weight: inherit;
text-transform: uppercase;
}

.figure p { text-align: inherit; }
figure-number { font-style: italic; }
#table-of-contents {
text-align: left;
position: fixed;
left: 0;
margin: 0 auto;
padding: 0;
width: 300px;
top: 0;
height: 100%;
border: 0;
display: block;
}
#text-table-of-contents {
overflow-y: scroll;
height: 100%;
}
#text-table-of-contents ul {
padding-left: 1em;
margin-left: 0.5em;
}
#table-of-contents > h2 {
padding: 0.1em;
margin: 0;
}
/* adjustments for small screen, toc at top only */
@media (max-width: 800px) { /* landscape for iphone */
html {
-webkit-text-size-adjust: none;  /* prevent scaling of text on mobile */
}
body {
background-color: #EEE;
width:100%;
margin:0 auto;
}
#content, #preamble, #postamble {
margin-left:0;
}
#table-of-contents {
position: static;
left: inherit;
width:inherit;
height: auto;
border-top: 0em;
padding: 0em .5em .5em .5em; /* top right bottom left */
margin: 1em 0em 1em 0em; /* top right bottom left */
border: 0.75em solid #006633;
}
div.outline-2, #table-of-contents {
background-color: rgb(250,250,250);
border: 0.75em solid var(--heading-bg-color);
border-top: 0em;
padding: 0em .5em .5em .5em; /* top right bottom left */
margin: 1em 0em 1em 0em; /* top right bottom left */
}
div.outline-2 > h2, #table-of-contents > h2 {
background-color: var(--heading-bg-color);
color: var(--heading-fg-color);
font-variant: small-caps;
padding: 0em 0em 0em .5em; /* top right bottom left */
margin: 0em -.5em 0em -.75em; /* top right bottom left */
text-align: left;
}
#text-table-of-contents {
overflow-y: visible;
height: inherit;
}
#text-table-of-contents ul {
padding-left: 1em;
margin-left: 0.5em;
}
}
.linenr { font-size: xx-small; }
}

@media print {
html {
font-family: serif;
font-size: 10pt;
text-align: justify;
.linenr { font-size: xx-small; }
}
}
</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="preamble" class="status">
<i>Last Updated: 2021-12-15 Wed 06:58</i>
</div>
<div id="content">
<h1 class="title">CSCI 2021 Lab15: Wrap-up and Review</h1>
<ul class="org-ul">
<li><b>Credit for Attendance</b></li>
<li>Exit Survey Due: 11:59pm Fri 12/17/2021</li>
<li>Lab exercises are open resource/open collaboration. You must submit
your own work but you may freely discuss lab topics with other
members of the class.</li>
</ul>

<div id="outline-container-orga2cda3e" class="outline-4">
<h4 id="orga2cda3e">CODE DISTRIBUTION: <a href="lab15-code.zip">lab15-code.zip</a></h4>
<div class="outline-text-4" id="text-orga2cda3e">
<ul class="org-ul">
<li>Download the code distribution every lab</li>
<li>See further setup instructions below</li>
</ul>
</div>
</div>

<div id="outline-container-org03c3476" class="outline-4">
<h4 id="org03c3476">CHANGELOG: Empty</h4>
<div class="outline-text-4" id="text-org03c3476">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgee9cb40">1. Rationale</a>
<ul>
<li><a href="#org66b1cf8">Associated Reading / Preparation</a></li>
<li><a href="#org3cb79b7">Grading Policy</a></li>
</ul>
</li>
<li><a href="#orgea915d5">2. Complete Project 5</a></li>
<li><a href="#orgf768c31">3. Review Questions</a>
<ul>
<li><a href="#orgff0956e">Review Problem 1</a></li>
<li><a href="#orgddc0036">Review Problem 2</a></li>
<li><a href="#org9ebca26">Review Problem 3</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-orgee9cb40" class="outline-2">
<h2 id="orgee9cb40"><span class="section-number-2">1</span> Rationale</h2>
<div class="outline-text-2" id="text-1">
<p>
This lab reviews concepts from earlier labs and lecture to prepare for
the final exam.  Lab leaders will give time to work, answer questions
on the review problems here, and lead discussion of solutions to them.
</p>
</div>

<div id="outline-container-org66b1cf8" class="outline-3">
<h3 id="org66b1cf8">Associated Reading / Preparation</h3>
<div class="outline-text-3" id="text-org66b1cf8">
<p>
Review the following sections from Bryant and O'Hallaron: 
</p>
<ul class="org-ul">
<li>Ch 9 on Virtual Memory and Paging</li>
<li>Ch 7 on Linking and the ELF Format</li>
<li>Previous chapters mentioned on the schedule to prepare for the
comprehensive portion of the final exam.</li>
</ul>
</div>
</div>

<div id="outline-container-org3cb79b7" class="outline-3">
<h3 id="org3cb79b7">Grading Policy</h3>
<div class="outline-text-3" id="text-org3cb79b7">
<ul class="org-ul">
<li>There is no material to submit for this lab.</li>
<li>There is an <a href="https://canvas.umn.edu/courses/268633/quizzes/490654">Exit Survey on Canvas</a> which is linked under the
Assignments section. This is an anonymous survey. Completing it will
earn <b>1 additional Engagemen Point</b></li>
<li>Students are also encouraged to complete the Student Rating of
Teaching for the course here: <a href="https://srt.umn.edu/blue">https://srt.umn.edu/blue</a>. A
sufficient response rate will trigger a final exam question to be
revealed during the last lecture.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgea915d5" class="outline-2">
<h2 id="orgea915d5"><span class="section-number-2">2</span> Complete Project 5</h2>
<div class="outline-text-2" id="text-2">
<p>
After taking the Exit Survey, TAs will be on hand to assist with
finishing Project 5 which is due soon. You may use Lab time to
work on the assignment and ask questions of course staff in person.
</p>
</div>
</div>

<div id="outline-container-orgf768c31" class="outline-2">
<h2 id="orgf768c31"><span class="section-number-2">3</span> Review Questions</h2>
<div class="outline-text-2" id="text-3">
<p>
The following questions can be used to review material likely to
appear on the Final Exam.
</p>
</div>

<div id="outline-container-orgff0956e" class="outline-3">
<h3 id="orgff0956e">Review Problem 1</h3>
<div class="outline-text-3" id="text-orgff0956e">
<p>
Consider the following C program which runs a function and reports the
addresses of several entities before pausing.
</p>

<div class="org-src-container">
<pre class="src src-c">#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;

int important_func(int arg1, long arg2){
  printf("%p : important_func()\n",&amp;important_func);
  printf("%p : arg1\n",&amp;arg1);
  printf("%p : arg2\n",&amp;arg2);
  printf("program pid is %d\n",getpid());
  printf("press any key to continue\n");
  getchar();
}

int main(int argc, char *argv[]){
  int x = 1;
  long y = 2;
  important_func(x, y);
  return 0;
}
</pre>
</div>

<p>
Running the program creates the following output.
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; gcc demoprog.c 
&gt; ./a.out
0x5575f7169169 : important_func()
0x7ffea79aa9bc : arg1
0x7ffea79aa9b0 : arg2
program pid is 11045
press any key to continue
</pre>
</div>

<p>
While the program is paused, <code>pmap</code> is invoked in another terminal and
produces the following. Certain lines numbered in comments on the
right.
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; pmap 11045
11045:   a.out                                 #Line
00005575f7168000      4K r---- a.out           # 1 
00005575f7169000      4K r-x-- a.out           # 2 
00005575f716a000      4K r---- a.out           # 3 
00005575f716b000      4K r---- a.out           # 4 
00005575f716c000      4K rw--- a.out           # 5 
00005575f8117000    132K rw---   [ anon ]      # 6 
00007fcdd5146000    136K r---- libc-2.29.so    # 7 
00007fcdd5168000   1328K r-x-- libc-2.29.so    # 8 
00007fcdd52b4000    304K r---- libc-2.29.so    # 9 
00007fcdd5300000      4K ----- libc-2.29.so    #10 
00007fcdd5301000     16K r---- libc-2.29.so    #11 
00007fcdd5305000      8K rw--- libc-2.29.so    #12 
00007fcdd5307000     24K rw---   [ anon ]      #13 
00007fcdd5340000      8K r---- ld-2.29.so      #14 
00007fcdd5342000    124K r-x-- ld-2.29.so      #15 
00007fcdd5361000     32K r---- ld-2.29.so      #16 
00007fcdd536a000      4K r---- ld-2.29.so      #17 
00007fcdd536b000      4K rw--- ld-2.29.so      #18 
00007fcdd536c000      4K rw---   [ anon ]      #19 
00007ffea798b000    132K rw---   [ stack ]     #20 
00007ffea79cf000     12K r----   [ anon ]      #21 
00007ffea79d2000      4K r-x--   [ anon ]      #22 
 total             2296K                        
</pre>
</div>

<p>
Answer the following questions.
</p>
<ol class="org-ol">
<li>Which specific lines of <code>pmap</code> output correspond to which entities
in the program? Aside from the address correspondence, what
information that <code>pmap</code> prints supports this correspondence?</li>
<li>Despite the entities <code>important_func()</code> and <code>arg1</code> appearing on the
same line of C code, they are assigned very different memory
addresses. Why is this the case?</li>
<li>We learned in our discussion of assembly programming that the first
6 arguments of functions are passed in registers and registers do
not have main memory addresses. However, the program prints out an
address for <code>arg1</code> and <code>arg2</code>. Explain what is going on and how
this discrepancy is resolved.</li>
</ol>
</div>

<div id="outline-container-org9f280ff" class="outline-4">
<h4 id="org9f280ff">SOLUTION</h4>
<div class="outline-text-4" id="text-org9f280ff">
<button onclick="document.getElementById('solution1').style.display='block'">Click for Solution</button>
<div id="solution1" style="display:none;">
<ol class="org-ol">
<li><p>
Correspondences are
</p>
<ul class="org-ul">
<li><p>
<code>important_func()</code>: pmap Line 2; the addresses are very close
together
</p>
<pre class="example">
0x005575f7169000 : pmap Line 2
0x005575f7169169 : important_func() in program
</pre>

<p>
This also makes sense because <code>pmap</code> shows permissions of <code>r-x</code>,
readable and executable, for this portion of the program, what
one would expect for a function.
</p></li>
</ul>
<ul class="org-ul">
<li><p>
<code>arg1 / arg2</code>: <code>pmap</code> Line 20; again the addresses are very close.
</p>
<pre class="example">
0x007ffea798b000 from pmap Line 20
0x007ffea79aa9b0 from arg2
0x007ffea79aa9bc from arg1
</pre>

<p>
This is also confirmed by the label for the <code>pmap</code> entry as
<code>[stack]</code> where local variables and arguments live and the
permissions of <code>rw-</code>, readable/writeable as one would expect for
data. 
</p></li>
</ul></li>
<li><code>important_func()</code> is a function and meant to be executed while
<code>arg1/arg2</code> are variables, data that is meant to be read and
written. To that end, they will be stored in different locations
with different permissions.  The <code>.text</code> section of ELF files will
be mapped into memory as the executable instructions, in this case
at a lower memory address of <code>0x005575f7169169</code>. This area does NOT
allow for write permission as the assembly instructions are not
expected to change. The data that those instructions operate on is
in different areas which do allow writing, in this case the stack
which is at <code>0x007ffea798b000</code>. The stack is only needed while the
program is running so has no corresponding ELF section: it is
created when the program is loaded to run.</li>
<li>The first 6 arguments to functions are passed in registers, in this
case <code>rdi</code> for <code>arg1</code> and <code>rsi</code> for <code>arg2</code>. However, the C code
dictates that these need a main memory address. So, the compiler
will generate an assembly sequence that writes the register values
into main memory, almost certainly in the stack where local
variables for functions are stored. This is confirmed by the
addresses printed, that <code>arg1, arg2</code> are located just after the
start of the stack.  This enables the address to be
printed. However, if the C code contained no mention of the need
for an address for <code>arg1 / arg2</code>, likely they would not need to be
in main memory at all and would solely be stored in registers to
increase execution efficiency.</li>
</ol>

</div>
</div>
</div>
</div>


<div id="outline-container-orgddc0036" class="outline-3">
<h3 id="orgddc0036">Review Problem 2</h3>
<div class="outline-text-3" id="text-orgddc0036">
<p>
The following is a compilation session that goes wrong. Study it and
the errors that ensue.
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; cat do_math.c                      # show code for program
// Demo program using math operations.
#include &lt;stdio.h&gt;
#include &lt;math.h&gt;
#include &lt;unistd.h&gt;

int main(int argc, char *argv[]){
  double e = M_E;
  double cos_e = cos(e);
  double sin_e = sin(e);
  double e_squared = pow(e,2.0);

  printf("E is %.3f\n",e);
  printf("cos(E) is %.3f\n",cos_e);
  printf("sin(E) is %.3f\n",sin_e);
  printf("E^2 is %.3f\n",e_squared);

  printf("program pid is %d\n",getpid());
  printf("press any key to continue\n");
  getchar();

  return 0;
}

&gt; gcc -c do_math.c                   # compile the code with -c option

&gt; file do_math.o
do_math.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped

&gt; gcc -o math_prog do_math.c         # compile the program to an executable
/usr/bin/ld: /tmp/ccNWf9Yu.o: in function `main':
do_math.c:(.text+0x26): undefined reference to `cos'
/usr/bin/ld: do_math.c:(.text+0x3d): undefined reference to `sin'
/usr/bin/ld: do_math.c:(.text+0x60): undefined reference to `pow'
collect2: error: ld returned 1 exit status
</pre>
</div>

<ol class="org-ol">
<li>Why is it that the first <code>gcc -c</code> compilation succeeds while the
second <code>gcc -o</code> fails? What is the difference between these two
invocations?</li>
<li>What role does the <code>math.h</code> header file play in this compilation
process? What would happen if it were removed?</li>
<li>What kind of error is reported in the second set of failures? Does
it require code changes to the <code>do_math.c</code> file?</li>
<li>How does one "fix" this problem to produce the ultimate executable.</li>
</ol>
</div>


<div id="outline-container-org827cb01" class="outline-4">
<h4 id="org827cb01">SOLUTION</h4>
<div class="outline-text-4" id="text-org827cb01">
<button onclick="document.getElementById('solution2').style.display='block'">Click for Solution</button>
<div id="solution2" style="display:none;">
<ol class="org-ol">
<li>The differences between <code>gcc</code> invocations are
<ul class="org-ul">
<li><code>gcc -c</code> means to 'compile only' which will produce a <code>.o</code> ELF
object file which is not yet executable. This is possible for the
<code>do_math.c</code> because it will simply convert the sole <code>main()</code>
function to assembly code in the <code>do_math.o</code> file.</li>
<li><code>gcc -o</code> or just <code>gcc</code> with no output options will attempt to
produce an executable and requires linking all the provided code
together along with any required libraries. This fails as the
<code>main()</code> function uses functions like <code>pow()</code> which are not
provided so an executable cannot be produced.</li>
</ul></li>
<li>The <code>math.h</code> file is included and provides prototypes for functions
like <code>pow()</code> and definitions for some mathematical constants like
<code>M_E</code> (base of the natural logarithm).  This ensures that the
compiler generates the assembly code sequence in <code>main()</code> to call
functions like <code>pow()</code> correctly. Without the header, it would be
easy to make a mistake such as passing arguments to <code>pow()</code> in
the wrong registers.</li>
<li>The error in <code>gcc -o</code> is a <b>Linking Error</b> as some compiled code is
missing, in this case the definitions of functions like <code>pow()</code>.
There is nothing wrong with the <code>do_math.c</code> file and no changes are
required in it. One simply needs to indicate to the compiler that
it should link against the math library.</li>
<li><p>
This problem is easily fixed by indicating <code>libm</code>, the math
library, should be linked with the following compiler invocation as
demonstrated below.
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; gcc -o math_prog do_math.c -lm         # compile and link to the math library

&gt; file math_prog                         # type of file for math_prog
math_prog: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked,
interpreter /lib64/ld-linux-x86-64.so.2

&gt; ./math_prog                            # run the executable
E is 2.718
cos(E) is -0.912
sin(E) is 0.411
E^2 is 7.389
program pid is 3329876
press any key to continue

&gt; 
</pre>
</div></li>
</ol>

</div>
</div>
</div>
</div>


<div id="outline-container-org9ebca26" class="outline-3">
<h3 id="org9ebca26">Review Problem 3</h3>
<div class="outline-text-3" id="text-org9ebca26">
<p>
Continuing the previous problem with the <code>do_math.c</code> program, while
running it the program, one can invoke <code>pmap</code> to gather information on
the working memory of the program. The shows two simultaneous runs of
<code>math_prog</code> along with its corresponding <code>pmap</code> information.
</p>

<div class="org-src-container">
<pre class="src src-sh">#### SHELL 1 ######                              #### SHELL 2 ######      
&gt; ./math_prog                                    &gt; ./math_prog            
E is 2.718                                       E is 2.718               
cos(E) is -0.912                                 cos(E) is -0.912         
sin(E) is 0.411                                  sin(E) is 0.411          
E^2 is 7.389                                     E^2 is 7.389             
program pid is 3334355                           program pid is 3335206   
press any key to continue                        press any key to continue

#### SHELL 3 ######                              #### SHELL 4 ######
&gt; pmap 3334355                                   &gt; pmap 3335206                              
3334355:   ./math_prog                           3335206:   ./math_prog                      
000055eb074de000      4K r---- math_prog         000055d42f543000      4K r---- math_prog    
000055eb074df000      4K r-x-- math_prog         000055d42f544000      4K r-x-- math_prog    
000055eb074e0000      4K r---- math_prog         000055d42f545000      4K r---- math_prog    
000055eb074e1000      4K r---- math_prog         000055d42f546000      4K r---- math_prog    
000055eb074e2000      4K rw--- math_prog         000055d42f547000      4K rw--- math_prog    
000055eb09132000    132K rw---   [ anon ]        000055d42f7fe000    132K rw---   [ anon ]   
00007f8a8f301000     12K rw---   [ anon ]        00007f465f83c000     12K rw---   [ anon ]   
00007f8a8f304000    148K r---- libc-2.30.so      00007f465f83f000    148K r---- libc-2.30.so 
00007f8a8f329000   1332K r-x-- libc-2.30.so      00007f465f864000   1332K r-x-- libc-2.30.so 
00007f8a8f476000    296K r---- libc-2.30.so      00007f465f9b1000    296K r---- libc-2.30.so 
00007f8a8f4c0000      4K ----- libc-2.30.so      00007f465f9fb000      4K ----- libc-2.30.so 
00007f8a8f4c1000     12K r---- libc-2.30.so      00007f465f9fc000     12K r---- libc-2.30.so 
00007f8a8f4c4000     12K rw--- libc-2.30.so      00007f465f9ff000     12K rw--- libc-2.30.so 
00007f8a8f4c7000     16K rw---   [ anon ]        00007f465fa02000     16K rw---   [ anon ]   
00007f8a8f4cb000     60K r---- libm-2.30.so      00007f465fa06000     60K r---- libm-2.30.so 
00007f8a8f4da000    624K r-x-- libm-2.30.so      00007f465fa15000    624K r-x-- libm-2.30.so 
00007f8a8f576000    612K r---- libm-2.30.so      00007f465fab1000    612K r---- libm-2.30.so 
00007f8a8f60f000      4K r---- libm-2.30.so      00007f465fb4a000      4K r---- libm-2.30.so 
00007f8a8f610000      4K rw--- libm-2.30.so      00007f465fb4b000      4K rw--- libm-2.30.so 
00007f8a8f611000      8K rw---   [ anon ]        00007f465fb4c000      8K rw---   [ anon ]   
00007f8a8f645000      8K r---- ld-2.30.so        00007f465fb80000      8K r---- ld-2.30.so   
00007f8a8f647000    124K r-x-- ld-2.30.so        00007f465fb82000    124K r-x-- ld-2.30.so   
00007f8a8f666000     32K r---- ld-2.30.so        00007f465fba1000     32K r---- ld-2.30.so   
00007f8a8f66f000      4K r---- ld-2.30.so        00007f465fbaa000      4K r---- ld-2.30.so   
00007f8a8f670000      4K rw--- ld-2.30.so        00007f465fbab000      4K rw--- ld-2.30.so   
00007f8a8f671000      4K rw---   [ anon ]        00007f465fbac000      4K rw---   [ anon ]   
00007ffcf2746000    132K rw---   [ stack ]       00007fff6782d000    132K rw---   [ stack ]  
00007ffcf27fc000     12K r----   [ anon ]        00007fff67876000     12K r----   [ anon ]   
00007ffcf27ff000      4K r-x--   [ anon ]        00007fff67879000      4K r-x--   [ anon ]   
ffffffffff600000      4K --x--   [ anon ]        ffffffffff600000      4K --x--   [ anon ]   
 total             3624K                          total             3624K                    
</pre>
</div>

<ol class="org-ol">
<li>The <code>pmap</code> listings show entries for <code>libc-2.30.so</code> and
<code>libm-2.30.so</code>. What are these entities and are they present in the
<code>do_math</code> program?</li>
<li>Identify several parts of the working memory of the two <code>math_prog</code>
processes that are distinct from each other. Also identify several
parts that are <b>shared</b> and describe how this sharing is possible.</li>
<li>Both processes report using <code>3624K</code> of memory. Do you expect that
once one process finishes, there will be <code>3264K</code> of memory made
available? Describe why or why not.</li>
</ol>
</div>

<div id="outline-container-orgd04d37e" class="outline-4">
<h4 id="orgd04d37e">SOLUTION</h4>
<div class="outline-text-4" id="text-orgd04d37e">
<button onclick="document.getElementById('solution3').style.display='block'">Click for Solution</button>
<div id="solution3" style="display:none;">
<ol class="org-ol">
<li><p>
The listings for <code>libm</code> and <code>libc</code> are the dynamically linked
libraries that are needed by <code>math_prog</code>.  While the names vary
slightly, one can see these are required by <code>math_prog</code> with
utilities like <code>ldd</code> which show dynamic library dependencies:
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; ldd math_prog
	linux-vdso.so.1 (0x00007ffe123ff000)
	libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007f98f5c11000)
	libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f98f5a4a000)
	/lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007f98f5d90000)
</pre>
</div>
<p>
<code>math_prog</code> uses printing facilities like <code>printf()</code> which are in
<code>libc</code> and the mathematical functions that are in <code>libm</code>. These are
NOT in the <code>math_prog</code> executable and are instead linked to it as
it is loaded to start running. For example, showing the symbol
table for <code>math_prog</code> identifies several of the functions needed
are undefined.
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; readelf -s math_prog
...
Symbol table '.symtab' contains 70 entries:
...
    51: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND pow@@GLIBC_2.29
    53: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND printf@@GLIBC_2.2.5
    65: 0000000000001199   261 FUNC    GLOBAL DEFAULT   13 main
    66: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND sin@@GLIBC_2.2.5
...
</pre>
</div>
<p>
In fact, <code>readelf -s</code> often reports on symbols in the <code>.dynsym</code>
which are dynamically linked symbols that are NOT in the executable
but come from other libraries.
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; readelf -s math_prog

Symbol table '.dynsym' contains 13 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab
     2: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND puts@GLIBC_2.2.5 (2)
     3: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND getpid@GLIBC_2.2.5 (2)
     4: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND pow@GLIBC_2.29 (3)
     5: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND printf@GLIBC_2.2.5 (2)
     6: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND cos@GLIBC_2.2.5 (4)
     7: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2.2.5 (2)
     8: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND getchar@GLIBC_2.2.5 (2)
     9: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__
    10: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND sin@GLIBC_2.2.5 (4)
    11: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable
    12: 0000000000000000     0 FUNC    WEAK   DEFAULT  UND __cxa_finalize@GLIBC_2.2.5 (2)
...
</pre>
</div></li>
</ol>


<ol class="org-ol">
<li>The first few sections of <code>math_prog</code> are likely distinct
corresponding to each process's Text and Global Data memory
areas. Also their Stack areas are likely distinct.  However, both
processes will share parts of the <code>libc</code> and <code>libm</code> memory,
especially that which is marked <code>r--</code> (read only) or <code>r-x</code>
(read/execute). Despite there being different virtual addresses
associated with these areas of memory, the OS Page Tables for these
processes will point them at the same Physical Locations so that
only a single copy of <code>libc</code> and <code>libm</code> needs to be in memory at
one time.</li>

<li>When a <code>math_prog</code> process finishes, it will release all its
exclusive memory such as Stack, Text, Heap, and Globals. This
memory can then be used by the operating system for other
purposes.  However, any shared libraries may remain in
memory. After one or both <code>math_prog</code> processes finish, if ANY
other processes are still using <code>libc</code> or <code>libm</code> they will remain
in memory. This makes it unlikely that the OS will reclaim the full
<code>3624K</code> when <code>math_prog</code> finishes.</li>
</ol>

</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<hr/> <i> Author: Chris Kauffman (<a href="mailto:kauffman@umn.edu">kauffman@umn.edu</a>) <br/> Date: 2021-12-15 Wed 06:58 <br/> </i>
</div>
</body>
</html>
